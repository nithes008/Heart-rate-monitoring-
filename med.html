<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CardioFusion Pro - Digital Cardiology Platform</title>
<!-- Load Chart.js for graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<!-- NEW: Load QR Code generator library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<!-- Load PDF libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- NEW: Load Three.js library for 3D simulation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<!-- Load Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  
  /* --- NEW: Medical Theme Colors --- */
  :root {
    --primary-color: #007a7c; /* A professional medical teal/blue */
    --primary-light: #e6f2f2;
    --header-bg: #ffffff;
    --page-bg: #f4f7f9;
    --card-bg: #ffffff;
    --text-primary: #1d1e2c;
    --text-secondary: #5a5f7d;
    --border-color: #e8e8e8;
    
    --risk-low-color: #388E3C;      /* Green */
    --risk-moderate-color: #F57C00; /* Orange */
    --risk-high-color: #D32F2F;      /* Red */
  }

  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    font-family: 'Inter', 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0; padding: 0;
    background: var(--page-bg);
    color: var(--text-primary);
    position: relative;
    overflow-x: hidden;
  }
  
  /* Animated AI Background */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #667eea 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    opacity: 0.1;
    z-index: -2;
  }
  
  body::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.15) 0%, transparent 50%),
      radial-gradient(circle at 40% 20%, rgba(240, 147, 251, 0.1) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
    z-index: -1;
  }
  
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 0.8; }
  }
  a {
    color: var(--primary-color);
    text-decoration: none;
  }
  /* Navbar */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 0 32px;
    height: 60px;
    position: sticky;
    top: 0;
    z-index: 1000;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    animation: slideDown 0.5s ease-out;
  }
  
  @keyframes slideDown {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  .logo {
    font-weight: 700;
    font-size: 1.5rem;
    color: var(--primary-color);
    letter-spacing: 1px;
  }
  .actions {
    display: flex;
    gap: 15px;
    align-items: center;
  }
  .button {
    user-select: none;
    font-weight: 600;
    padding: 8px 20px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  
  .button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }
  
  .button:hover::before {
    width: 300px;
    height: 300px;
  }
  .button.secondary {
    background: transparent;
    border: 1.5px solid var(--primary-color);
    color: var(--primary-color);
  }
  .button.secondary:hover {
    background: var(--primary-color);
    color: #fff;
  }
  .button.primary {
    background: var(--primary-color);
    color: #fff;
  }
  .button.primary:hover {
    background: #005a5c;
  }

  /* Hero Section */
  .hero {
    position: relative;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 50%, rgba(79, 172, 254, 0.05) 100%);
    padding: 100px 24px 140px;
    text-align: center;
    color: var(--text-primary);
    overflow: hidden;
  }
  
  /* Animated particles/geometric shapes */
  .hero::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: 
      radial-gradient(circle, rgba(102, 126, 234, 0.1) 1px, transparent 1px),
      radial-gradient(circle, rgba(118, 75, 162, 0.1) 1px, transparent 1px);
    background-size: 50px 50px, 30px 30px;
    animation: float 20s linear infinite;
    z-index: 0;
  }
  
  .hero::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
    animation: shine 3s infinite;
    z-index: 1;
  }
  
  .hero > * {
    position: relative;
    z-index: 2;
  }
  
  @keyframes float {
    0% { transform: translate(0, 0) rotate(0deg); }
    100% { transform: translate(-50px, -50px) rotate(360deg); }
  }
  
  @keyframes shine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  .hero h1 {
    font-family: 'Space Grotesk', 'Geist', 'Inter', sans-serif;
    font-weight: 800;
    font-size: 3.25rem;
    line-height: 1.1;
    max-width: 750px;
    margin: 0 auto 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #667eea 100%);
    background-size: 300% 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientText 5s ease infinite;
    animation-delay: 0.3s;
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 0.8s ease-out 0.3s forwards, gradientText 5s ease infinite 1s;
  }
  
  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes gradientText {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .hero form {
    display: inline-flex;
    max-width: 620px;
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2);
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    animation: formSlideIn 0.6s ease-out 0.5s backwards;
  }
  
  @keyframes formSlideIn {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .hero input[type="text"] {
    flex-grow: 1;
    padding: 14px 20px;
    border: none;
    font-size: 1rem;
    color: #333;
  }
  .hero input[type="text"]:focus {
    outline: 2px solid var(--primary-color);
  }
  .hero select {
    border: none;
    background: white;
    color: #333;
    font-weight: 600;
    font-size: 1rem;
    padding: 14px 12px;
    border-left: 1px solid #eee;
    cursor: pointer;
  }
  .hero button {
    background: linear-gradient(135deg, var(--ai-gradient-1), var(--ai-gradient-2));
    border: none;
    color: white;
    font-weight: 700;
    font-size: 1.05rem;
    padding: 14px 28px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  
  .hero button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
  }
  
  .hero button:hover {
    background: linear-gradient(135deg, var(--ai-gradient-2), var(--ai-gradient-1));
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }
  
  .hero button:hover::before {
    left: 100%;
  }

  /* Category Pills */
  .categories {
    margin: 40px auto 0;
    max-width: 900px;
    display: flex;
    justify-content: center;
    gap: 16px;
    flex-wrap: wrap;
    user-select: none;
  }
  .pill {
    padding: 10px 22px;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 100px;
    border: 1.5px solid var(--primary-color);
    cursor: pointer;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: var(--primary-color);
    position: relative;
    overflow: hidden;
  }
  
  .pill::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--ai-gradient-1), var(--ai-gradient-2));
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
    z-index: -1;
  }
  
  .pill.active,
  .pill:hover {
    background: linear-gradient(135deg, var(--ai-gradient-1), var(--ai-gradient-2));
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  }
  
  .pill.active::before,
  .pill:hover::before {
    width: 300px;
    height: 300px;
  }

  /* Slider Container */
  .slider-wrapper {
    max-width: 960px;
    margin: 60px auto 120px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    animation: wrapperFadeIn 0.8s ease-out 0.7s backwards;
  }
  
  @keyframes wrapperFadeIn {
    from {
      opacity: 0;
      transform: translateY(40px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  .cards {
    display: flex;
    gap: 24px;
    scroll-behavior: smooth;
    overflow-x: auto;
    padding-bottom: 8px;
    scrollbar-width: none;
  }
  .cards::-webkit-scrollbar { display: none; }

  /* Single Card */
  .card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: var(--text-primary);
    min-width: 310px;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.5);
    padding: 24px 28px;
    flex-shrink: 0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
    animation: cardFadeIn 0.6s ease-out backwards;
  }
  
  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
  }
  
  .card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.2), 0 0 0 1px rgba(102, 126, 234, 0.3);
  }
  
  .card:hover::before {
    left: 100%;
  }
  
  .card:nth-child(1) { animation-delay: 0.1s; }
  .card:nth-child(2) { animation-delay: 0.2s; }
  .card:nth-child(3) { animation-delay: 0.3s; }
  .card:nth-child(4) { animation-delay: 0.4s; }
  .card:nth-child(5) { animation-delay: 0.5s; }
  .card:nth-child(6) { animation-delay: 0.6s; }
  .card:nth-child(7) { animation-delay: 0.7s; }
  .card:nth-child(8) { animation-delay: 0.8s; }
  .card:nth-child(9) { animation-delay: 0.9s; }
  .card:nth-child(10) { animation-delay: 1.0s; }
  .card:nth-child(11) { animation-delay: 1.1s; }
  .card:nth-child(12) { animation-delay: 1.2s; }
  
  @keyframes cardFadeIn {
    from {
      opacity: 0;
      transform: translateY(30px) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  .card h3 {
    margin-top: 0;
    margin-bottom: 16px;
    font-weight: 700;
    font-size: 1.3rem;
  }
  .card ul {
    list-style: none;
    padding-left: 0;
    margin-bottom: 20px;
    font-size: 0.95rem;
    line-height: 1.4;
  }
  .card ul li {
    margin-bottom: 9px;
    position: relative;
    padding-left: 20px;
  }
  .card ul li::before {
    content: "•";
    position: absolute;
    left: 0;
    color: var(--primary-color);
    font-weight: 700;
  }
  .card .btn-try {
    display: inline-block;
    background-color: var(--primary-color);
    color: white;
    font-weight: 700;
    text-align: center;
    padding: 12px 30px;
    border-radius: 30px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s;
  }
  .card .btn-try:hover { background-color: #005a5c; }

  /* Arrows */
  .arrow-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background-color: rgba(0, 122, 124, 0.8);
    color: #fff;
    font-size: 1.8rem;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }
  .arrow-btn:hover { background-color: var(--primary-color); }
  .arrow-left { left: -22px; }
  .arrow-right { right: -22px; }
  .arrow-btn:disabled { opacity: 0.2; cursor: default; }

  /* ==============================================
  == NEW STYLES FOR FULL-SCREEN APP PAGES ==
  ==============================================
  */
  
  .app-page {
    display: none; /* Hide all app pages by default */
    min-height: 100vh;
    padding: 40px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 50%, rgba(79, 172, 254, 0.03) 100%);
    color: var(--text-primary);
    position: relative;
    animation: pageFadeIn 0.5s ease-out;
  }
  
  @keyframes pageFadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* App Page Header */
  .app-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1400px;
    margin: 0 auto 30px auto;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
  }
  .app-header h1 {
    font-size: 2.5rem;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
  }
  .app-header h1 i {
    margin-right: 15px;
    color: var(--primary-color);
  }
  .back-btn {
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    background: var(--primary-color);
    padding: 12px 20px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .back-btn:hover {
    background: #005a5c;
  }
  
  .app-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  /* --- Styles for the Dashboard inside the pages --- */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }
  .full-width-grid {
    grid-template-columns: 1fr;
  }
  .left-column, .right-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  /* Use .app-card for content blocks inside pages */
  .app-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
    animation: fadeInScale 0.5s ease-out;
  }
  
  .app-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15), 0 0 0 1px rgba(102, 126, 234, 0.2);
  }
  
  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  .card-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-top: 0;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    color: var(--text-primary);
  }
  .card-title i {
    margin-right: 10px;
    color: var(--primary-color);
  }
  
  /* Form group styles */
  .form-group { margin-bottom: 20px; }
  .form-group label { display: block; font-weight: 500; margin-bottom: 10px; }
  .form-group .slider-value {
    float: right; font-weight: 600; color: var(--primary-color);
  }
  input[type="range"] { width: 100%; cursor: pointer; }
  input[type="text"], select {
    width: 100%; padding: 12px; border: 1px solid var(--border-color);
    border-radius: 8px; background-color: #f9f9f9;
    font-size: 1rem;
  }
  .submit-btn {
    width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 600;
    color: white; background-color: var(--primary-color);
    border: none; border-radius: 8px; cursor: pointer;
    transition: background-color 0.3s;
  }
  .submit-btn:hover { background-color: #005a5c; }
  .submit-btn:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }

  /* Stats card styles */
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .stat-item h3 { font-size: 1rem; color: #555; margin: 0 0 5px 0; font-weight: 500; }
  .stat-item p { font-size: 2.2rem; font-weight: 600; margin: 0; color: #1d133a; }
  
  /* Vitals card colors based on risk */
  .vitals-risk-low p { color: var(--risk-low-color); }
  .vitals-risk-moderate p { color: var(--risk-moderate-color); }
  .vitals-risk-high p { color: var(--risk-high-color); }
  
  /* --- NEW: Risk Score Page Styles --- */
  .risk-score-grid {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 30px;
    align-items: flex-start;
  }
  .risk-score-card {
    padding: 30px;
    text-align: center;
  }
  .risk-score-card .score {
    font-size: 6rem;
    font-weight: 800;
    line-height: 1;
    margin: 20px 0 10px 0;
  }
  .risk-score-card .category {
    font-size: 1.8rem;
    font-weight: 600;
    margin: 0;
  }
  .risk-score-card .score.risk-low, .risk-score-card .category.risk-low { color: var(--risk-low-color); }
  .risk-score-card .score.risk-moderate, .risk-score-card .category.risk-moderate { color: var(--risk-moderate-color); }
  .risk-score-card .score.risk-high, .risk-score-card .category.risk-high { color: var(--risk-high-color); }
  
  .contact-relative-btn {
    width: 100%;
    padding: 15px;
    font-size: 1.1rem;
    font-weight: 600;
    color: white;
    background-color: var(--primary-color);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 25px;
  }
  .contact-relative-btn:hover { background-color: #005a5c; }
  
  /* --- NEW: ECG Page Styles --- */
  #ecgChartContainer {
    width: 100%;
    height: 250px;
    position: relative;
    /* NEW: ECG Grid Background */
    background-color: #000;
    background-image: 
      linear-gradient(rgba(0, 255, 0, 0.15) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 255, 0, 0.15) 1px, transparent 1px),
      linear-gradient(rgba(0, 255, 0, 0.08) 0.5px, transparent 0.5px),
      linear-gradient(90deg, rgba(0, 255, 0, 0.08) 0.5px, transparent 0.5px);
    background-size: 40px 40px, 40px 40px, 8px 8px, 8px 8px;
    border-radius: 8px;
  }
  .ecg-vitals-bar {
    display: flex;
    justify-content: space-around;
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    margin-top: 20px;
  }
  .ecg-vitals-bar .stat-item { text-align: center; }
  .ecg-controls {
    text-align: center;
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 15px;
  }
  .ecg-controls .button {
    margin: 0 10px;
    min-width: 150px;
  }
  
  /* Personalized Care styles */
  .care-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
  }
  .care-section ul { list-style: none; padding-left: 0; }
  .care-section li {
    position: relative;
    padding-left: 25px;
    margin-bottom: 10px;
    font-size: 1rem;
    line-height: 1.5;
  }
  .care-section li::before {
    content: '✓';
    position: absolute;
    left: 0;
    color: #388E3C;
    font-weight: 700;
  }
  .care-section .icon-title {
    font-size: 1.2rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 5px;
    margin-bottom: 15px;
  }
  .care-section .icon-title i {
    font-size: 1.5rem;
    width: 30px;
    text-align: center;
  }
  
  /* Clinical Report styles */
  #report-content-wrapper {
    background: #fafafa;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    height: 500px;
    overflow-y: auto;
  }
  #report-content {
    padding: 25px;
    font-family: 'Courier New', Courier, monospace;
    line-height: 1.6;
    white-space: pre-wrap; 
  }
  /* NEW: QR Code styles */
  #qr-code-container {
    padding: 20px;
    text-align: center;
  }
  #report-qr-code {
    border: 5px solid #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  .download-btn {
    display: inline-block;
    margin-top: 20px;
    padding: 12px 25px;
    font-size: 1rem;
    font-weight: 600;
    color: white;
    background-color: #388E3C;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-right: 10px;
  }

  /* Telemedicine Page Styles */
  .telemedicine-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
  }
  .video-placeholder {
    width: 100%;
    height: 500px;
    background: #1d133a;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 1.5rem;
    font-weight: 600;
    position: relative;
    overflow: hidden; /* To contain the video */
  }
  .video-placeholder i {
    font-size: 5rem;
    margin-bottom: 20px;
    opacity: 0.5;
    transition: all 0.3s;
  }
  /* NEW: Local and remote video styles */
  #local-video {
    display: none;
    width: 25%;
    height: 25%;
    object-fit: cover;
    position: absolute;
    bottom: 20px;
    right: 20px;
    border-radius: 8px;
    border: 2px solid var(--primary-color);
    z-index: 15;
    transform: scaleX(-1); /* Mirror effect */
  }
  #remote-video-placeholder {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    transition: all 0.3s;
  }
  #remote-video-placeholder.connected {
    background-image: url('https://placehold.co/800x600/1d133a/ffffff?text=Connecting+to+Doctor...');
    background-size: cover;
    background-position: center;
  }
  .video-placeholder .video-controls {
    position: absolute;
    bottom: 20px;
    z-index: 10;
    display: flex;
    gap: 15px;
  }

  .chat-box {
    display: flex;
    flex-direction: column;
    height: 500px;
  }
  .chat-messages {
    flex-grow: 1;
    background: #fafafa;
    border: 1px solid var(--border-color);
    border-radius: 8px 8px 0 0;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .chat-message {
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    line-height: 1.4;
  }
  .chat-message.user {
    background-color: var(--primary-color);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }
  .chat-message.bot {
    background-color: #e0e0e0;
    color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }
  .chat-message.bot.typing {
    color: #777;
    font-style: italic;
  }
  .chat-input {
    display: flex;
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 8px 8px;
  }
  .chat-input input {
    flex-grow: 1;
    border: none;
    padding: 15px;
    font-size: 1rem;
    border-radius: 0 0 0 8px;
  }
  .chat-input input:focus {
    outline: none;
  }
  .chat-input button {
    border: none;
    background: var(--primary-color);
    color: white;
    padding: 0 20px;
    font-size: 1.2rem;
    cursor: pointer;
    border-radius: 0 0 8px 0;
  }
  
  /* Simple warning for un-assessed data */
  .assessment-warning {
    text-align: center;
    font-size: 1.2rem;
    font-weight: 500;
    color: #555;
    padding: 40px;
    background: #fafafa;
    border-radius: 8px;
  }
  .assessment-warning i {
    font-size: 3rem;
    color: var(--primary-color);
    display: block;
    margin-bottom: 20px;
  }
  .assessment-warning button {
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    background: var(--primary-color);
    padding: 12px 20px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 20px;
  }

  /* --- NEW: High Risk Alarm Modal --- */
  .alarm-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 3000;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s;
  }
  .alarm-modal-overlay.open {
    opacity: 1;
    visibility: visible;
  }
  .alarm-modal-content {
    background: #fff;
    color: #333;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    padding: 30px;
    text-align: center;
    border: 5px solid var(--risk-high-color);
    animation: pulse-border 1s infinite;
  }
  .alarm-modal-content i {
    font-size: 5rem;
    color: var(--risk-high-color);
    animation: shake 0.5s infinite;
  }
  .alarm-modal-content h1 {
    color: var(--risk-high-color);
    margin: 10px 0;
  }
  .alarm-modal-content p {
    font-size: 1.1rem;
    line-height: 1.5;
    margin-bottom: 25px;
  }
  .alarm-btn {
    width: 100%;
    padding: 15px;
    font-size: 1.1rem;
    font-weight: 600;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 10px;
  }
  .alarm-btn.sop-btn {
    background-color: var(--risk-high-color);
  }
  .alarm-btn.dismiss-btn {
    background-color: #555;
  }
  
  /* --- NEW: SMS Modal --- */
  .sms-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 4000; /* Above alarm */
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s;
  }
  .sms-modal-overlay.open {
    opacity: 1;
    visibility: visible;
  }
  .sms-modal-content {
    background: #fff;
    color: #333;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    padding: 30px;
  }
  .sms-modal-content h2 {
    margin-top: 0;
    color: var(--text-primary);
  }
  .sms-modal-content .form-group label {
    font-weight: 600;
  }
  .sms-modal-content .form-group input,
  .sms-modal-content .form-group textarea {
    background: #f0f2f5;
  }
  .sms-modal-content textarea {
    height: 150px;
    resize: vertical;
    font-family: 'Inter', sans-serif;
  }
  .sms-modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  .sms-modal-actions .button.secondary {
    background-color: #eee;
    color: #555;
    border-color: #eee;
  }
  .sms-modal-actions .button.secondary:hover {
    background-color: #ddd;
    border-color: #ddd;
  }

  /* --- NEW: Patient Cohort Table --- */
  .table-wrapper {
      max-height: 250px;
      overflow-y: auto;
  }
  .patient-table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
  }
  .patient-table th, .patient-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
  }
  .patient-table th {
      font-weight: 600;
      color: #555;
      position: sticky;
      top: 0;
      background: #fff;
  }
  .patient-table .risk-low { color: var(--risk-low-color); }
  .patient-table .risk-moderate { color: var(--risk-moderate-color); }
  .patient-table .risk-high { color: var(--risk-high-color); }
  .patient-table .current-patient-row {
      background-color: #fffbeb;
      font-weight: 700;
  }
  
  @keyframes pulse-border {
    0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(211, 47, 47, 0); }
    100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  @keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

</style>
</head>
<body>

<header>
  <div class="logo">CARDIOFUSION</div>
  <nav>
    <!-- Nav items removed as requested -->
  </nav>
  <div class="actions">
    <button class="button secondary" onclick="exportAllDataAsPDF()" title="Export All Data as PDF">
      <i class="fa-solid fa-file-pdf"></i> Export PDF
    </button>
    <button class="button secondary" onclick="exportAllChartData()" title="Export All Chart Data">
      <i class="fa-solid fa-download"></i> Export Data
    </button>
    <button class="button secondary">Log In</button>
    <button class="button primary">Sign Up</button>
  </div>
</header>

<!-- This wrapper contains the main landing page content -->
<div id="main-landing-page">
  <section class="hero">
    <h1>Win digital <span style="background:linear-gradient(90deg, var(--primary-color) 0%, #004a4c 100%); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;">cardiac health visibility</span>, everywhere it matters</h1>
    <!-- NEW: Patient ID Search Form -->
    <form id="patient-search-form">
      <input id="patient-id-search" type="text" placeholder="Enter Patient ID" aria-label="Enter Patient ID" required />
      <button type="submit">Find Patient</button>
    </form>

    <nav class="categories" aria-label="Cardiology service categories">
      <div class="pill" data-page="page-heart-rate">Heart Rate</div>
      <div class="pill" data-page="page-ecg">ECG Analysis</div>
      <div class="pill" data-page="page-risk-score">Risk Score</div>
      <div class="pill" data-page="page-personalized-care">Personalized Care</div>
      <!-- MODIFIED: Link to the new Clinical Decision Layer -->
      <div class="pill" data-page="page-ai-predictions">Clinical Decision Layer</div>
      <div class="pill" data-page="page-clinical-reports">Clinical Reports</div>
      <div class="pill" data-page="page-telemedicine">Telemedicine</div>
      <div class="pill" data-page="page-heart-models">Heart Models</div>
      <div class="pill" data-page="page-data-fusion">Data Fusion</div>
      <div class="pill" data-page="page-adaptive-models">Adaptive Models</div>
      <div class="pill" data-page="page-ml-optimization">ML Optimization</div>
      <div class="pill" data-page="page-data-management">Data Management</div>
    </nav>

    <div class="slider-wrapper">
      <button class="arrow-btn arrow-left" aria-label="Scroll left" disabled>&lt;</button>
      <div class="cards">
        <article class="card" tabindex="0">
          <h3>Heart Rate Monitoring</h3>
          <ul>
            <li>Real-time heart rate from wearables</li>
            <li>Continuous health tracking & alerts</li>
            <li>Data export for clinicians</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-heart-rate" tabindex="0">Try for free</a>
        </article>
        <article class="card" tabindex="0">
          <h3>ECG Analysis</h3>
          <ul>
            <li>AI-powered arrhythmia detection</li>
            <li>24/7 ECG monitoring and recording</li>
            <li>Automatic anomaly reports</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-ecg" tabindex="0">Try for free</a>
        </article>
        <article class="card" tabindex="0">
          <h3>Risk Score</h3>
          <ul>
            <li>Personalized cardiovascular risk formula</li>
            <li>HIPAA-compliant secure data handling</li>
            <li>Actionable recommendations</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-risk-score" tabindex="0">Try for free</a>
        </article>
        <article class="card" tabindex="0">
          <h3>Personalized Care</h3>
          <ul>
            <li>Adaptive care plans with clinician input</li>
            <li>Medication & lifestyle optimization</li>
            <li>Patient engagement tools</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-personalized-care" tabindex="0">Try for free</a>
        </article>
        <!-- MODIFIED: Card for the new Clinical Decision Layer -->
        <article class="card" tabindex="0">
          <h3>Clinical Decision Layer</h3>
          <ul>
            <li>Simulated Anomaly Detection</li>
            <li>AI-Driven Risk Stratification</li>
            <li>Adaptive Treatment Suggestions</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-ai-predictions" tabindex="0">Try for free</a>
        </article>
        <article class="card" tabindex="0">
          <h3>Clinical Reports</h3>
          <ul>
            <li>Automated cardiology reports</li>
            <li>Integration with hospital systems</li>
            <li>Real-time data sharing with care teams</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-clinical-reports" tabindex="0">Try for free</a>
        </article>
        <article class="card" tabindex="0">
          <h3>Telemedicine</h3>
          <ul>
            <li>Video consultations with specialists</li>
            <li>Remote monitoring & data review</li>
            <li>Secure patient-clinician messaging</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-telemedicine" tabindex="0">Try for free</a>
        </article>
        <!-- NEW: Advanced Features -->
        <article class="card" tabindex="0">
          <h3><i class="fa-solid fa-heart-pulse"></i> Electromechanical Heart Models</h3>
          <ul>
            <li>Electrophysiology integration</li>
            <li>Hemodynamics & mechanics modeling</li>
            <li>3D heart visualization & simulation</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-heart-models" tabindex="0">Try for free</a>
        </article>
        <article class="card" tabindex="0">
          <h3><i class="fa-solid fa-layer-group"></i> Multimodal Data Fusion</h3>
          <ul>
            <li>Wearable ECG integration</li>
            <li>MRI/CT imaging fusion</li>
            <li>EHR data synchronization</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-data-fusion" tabindex="0">Try for free</a>
        </article>
        <article class="card" tabindex="0">
          <h3><i class="fa-solid fa-arrows-rotate"></i> Adaptive Models</h3>
          <ul>
            <li>Continuous feedback learning</li>
            <li>Evolving prediction models</li>
            <li>Real-time model updates</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-adaptive-models" tabindex="0">Try for free</a>
        </article>
        <article class="card" tabindex="0">
          <h3><i class="fa-solid fa-brain"></i> ML Treatment Optimization</h3>
          <ul>
            <li>Personalized predictions</li>
            <li>Treatment plan optimization</li>
            <li>Advanced ML algorithms</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-ml-optimization" tabindex="0">Try for free</a>
        </article>
        <article class="card" tabindex="0">
          <h3><i class="fa-solid fa-shield-halved"></i> Secure Data Management</h3>
          <ul>
            <li>HIPAA-compliant infrastructure</li>
            <li>Scalable cloud architecture</li>
            <li>Healthcare standards compliance</li>
          </ul>
          <a href="#" class="btn-try" data-page="page-data-management" tabindex="0">Try for free</a>
        </article>
      </div>
      <button class="arrow-btn arrow-right" aria-label="Scroll right">&gt;</button>
    </div>
  </section>
</div> <!-- End #main-landing-page -->


<!-- 
==============================================
== NEW FULL-SCREEN APP PAGES ==
==============================================
-->

<div id="app-page-wrapper">

  <!-- 1. Heart Rate Monitoring (Data Input) -->
  <div class="app-page" id="page-heart-rate">
    <div class="app-header">
      <!-- MODIFIED: Title to reflect "Patient & Sensors Layer" -->
      <h1><i class="fa-solid fa-file-medical"></i> Patient & Sensors Layer (Input)</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container">
      <div class="dashboard-grid">
        <div class="left-column">
          <div class="app-card">
            <h2 class="card-title">Enter Your Health Metrics</h2>
            <form id="risk-form">
              <div class="form-group">
                  <label for="patient-name">Patient Name</label>
                  <input type="text" id="patient-name" placeholder="Enter Your Name" required>
              </div>
              <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
              </div>
              <div class="form-group">
                  <label for="age">Age <span class="slider-value" id="age-value">45</span></label>
                  <input type="range" id="age" min="20" max="80" value="45">
              </div>
              <div class="form-group">
                  <label for="cp">Chest Pain Type</label>
                  <select id="cp">
                      <option value="0">Typical Angina</option>
                      <option value="1">Atypical Angina</option>
                      <option value="2">Non-Anginal Pain</option>
                      <option value="3">Asymptomatic</option>
                  </select>
              </div>
              <div class="form-group">
                  <label for="thalach">Max Heart Rate <span class="slider-value" id="thalach-value">150</span></label>
                  <input type="range" id="thalach" min="70" max="220" value="150">
                  <!-- NEW: Camera Button -->
                  <button type="button" class="button secondary" id="camera-hr-btn" style="width: 100%; margin-top: 10px;">
                      <i class="fa-solid fa-camera"></i> Scan Face for Heart Rate (Beta)
                  </button>
                  <video id="camera-feed" style="display: none; width: 100%; border-radius: 8px; margin-top: 10px; transform: scaleX(-1);"></video>
                  <p id="camera-status" style="text-align: center; font-weight: 600; color: var(--primary-color);"></p>
              </div>
              <div class="form-group">
                  <label for="oldpeak">ST Depression <span class="slider-value" id="oldpeak-value">1.0</span></label>
                  <input type="range" id="oldpeak" min="0" max="6.2" step="0.1" value="1.0">
              </div>
              <div class="form-group">
                  <label for="thal">Thallium Test Result</label>
                  <select id="thal">
                      <option value="1">Normal</option>
                      <option value="2">Fixed Defect</option>
                      <option value="3">Reversible Defect</option>
                  </select>
              </div>
              <button type="submit" class="submit-btn">
                  <i class="fa-solid fa-magnifying-glass"></i> Assess Risk & View Score
              </button>
            </form>
          </div>
        </div>
        <div class="right-column">
          <!-- Live Vitals Card - Now starts hidden -->
          <div class="app-card" id="live-vitals-dashboard" style="display: none;">
            <h2 class="card-title"><i class="fa-solid fa-heart-pulse"></i> Live Vitals</h2>
            <div class="stats-grid" id="vitals-grid-dash">
              <div class="stat-item"><p id="vital-bpm-dash">--</p><h3>BPM</h3></div>
              <div class="stat-item"><p id="vital-pr-dash">--</p><h3>PR (ms)</h3></div>
              <div class="stat-item"><p id="vital-rr-dash">--</p><h3>RR (ms)</h3></div>
              <div class="stat-item"><p id="vital-tm-dash">--</p><h3>TM (s)</h3></div>
            </div>
          </div>
          <!-- Health Stats (History) -->
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-chart-line"></i> Health Statistics</h2>
            <!-- NEW: Historical Risk Chart -->
            <div style="position: relative;">
              <canvas id="historicalRiskChart" style="height: 120px; margin-bottom: 20px;"></canvas>
              <button class="button secondary" onclick="downloadChartData('historicalRiskChart', 'HistoricalRisk')" style="position: absolute; top: 0; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save
              </button>
            </div>
            <div class="stats-grid">
              <div class="stat-item" id="total-assessments">
                  <h3>Total Assessments</h3>
                  <p>0</p>
              </div>
              <div class="stat-item" id="avg-risk">
                  <h3>Average Risk Score</h3>
                  <p>0.0%</p>
              </div>
              <div class="stat-item" id="last-assessment" style="grid-column: 1 / -1;">
                  <h3>Last Assessment</h3>
                  <p>N/A</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 2. ECG Analysis (NEW DESIGN) -->
  <div class="app-page" id="page-ecg">
    <div class="app-header">
      <h1><i class="fa-solid fa-wave-square"></i> Real-Time ECG Analysis</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container" id="ecg-content">
        <div class="app-card">
            <h2 class="card-title">Live ECG Monitor</h2>
            <div id="ecgChartContainer">
                <canvas id="ecgChart"></canvas>
                <button class="button secondary" onclick="downloadChartData('ecgChart', 'ECG')" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 0.8rem; z-index: 10;">
                  <i class="fa-solid fa-download"></i> Save Data
                </button>
            </div>
            <div class="ecg-vitals-bar" id="vitals-grid-ecg">
                <div class="stat-item"><p id="vital-bpm-ecg">--</p><h3>BPM</h3></div>
                <div class="stat-item"><p id="vital-pr-ecg">--</p><h3>PR (ms)</h3></div>
                <div class="stat-item"><p id="vital-rr-ecg">--</p><h3>RR (ms)</h3></div>
                <div class="stat-item"><p id="vital-tm-ecg">--</p><h3>TM (s)</h3></div>
            </div>
            <div class="ecg-controls">
                <button class="button primary" id="start-ecg-btn">Start Monitoring</button>
                <button class="button secondary" id="stop-ecg-btn">Stop Monitoring</button>
                <button class="button" id="download-ecg-btn" style="background-color: #388E3C;"><i class="fa-solid fa-download"></i> Download ECG</button>
            </div>
        </div>
    </div>
  </div>

  <!-- 3. Risk Score (NEW DESIGN) -->
  <div class="app-page" id="page-risk-score">
    <div class="app-header">
      <h1><i class="fa-solid fa-gauge-high"></i> AI Risk Score</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container" id="risk-content">
      <div class="risk-score-grid">
        <div class="left-column">
          <div class="app-card risk-score-card">
            <h2 class="card-title" style="justify-content: center;">Your Risk Score</h2>
            <p class="score risk-low" id="risk-score-value">--</p>
            <p class="category risk-low" id="risk-score-category">Not Assessed</p>
            <button class="contact-relative-btn" id="contact-relative-btn-1" style="display: none;">
                <i class="fa-solid fa-paper-plane"></i> Send Alert to Relatives
            </button>
          </div>
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-sliders"></i> Your Risk Factors</h2>
            <div class="form-group">
                <label>Age: <span class="slider-value" id="factor-age">--</span></label>
            </div>
            <div class="form-group">
                <label>Chest Pain: <span class="slider-value" id="factor-cp">--</span></label>
            </div>
            <div class="form-group">
                <label>Max Heart Rate: <span class="slider-value" id="factor-thalach">--</span></label>
            </div>
            <div class="form-group">
                <label>ST Depression: <span class="slider-value" id="factor-oldpeak">--</span></label>
            </div>
          </div>
        </div>
        <div class="right-column">
          <!-- NEW: Patient Cohort Table -->
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-users"></i> Patient Cohort Comparison</h2>
            <div class="table-wrapper">
              <table class="patient-table">
                <thead>
                  <tr>
                    <th>Patient ID</th>
                    <th>Name</th>
                    <th>Heart Rate</th>
                    <th>Risk Score</th>
                    <th>Category</th>
                  </tr>
                </thead>
                <tbody id="patient-cohort-table">
                  <!-- JS will populate this -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-chart-bar"></i> Risk Distribution</h2>
            <div style="position: relative;">
              <canvas id="riskDistributionChart" style="height: 180px;"></canvas>
              <button class="button secondary" onclick="downloadChartData('riskDistributionChart', 'RiskDistribution')" style="position: absolute; top: 0; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 4. Personalized Care -->
  <div class="app-page" id="page-personalized-care">
    <div class="app-header">
      <h1><i class="fa-solid fa-user-doctor"></i> Personalized Care Plan</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container" id="care-content">
      <div class="app-card">
        <p style="text-align: center; font-size: 1.1rem; color: #555;">Based on your assessment, our AI has generated the following recommendations to help you manage your cardiovascular health.</p>
        <div class="care-grid">
          <div class="care-section" id="ai-diet">
              <h3 class="icon-title"><i class="fa-solid fa-utensils" style="color: var(--risk-low-color);"></i> Diet Recommendations</h3>
              <ul><li>Please run an assessment first.</li></ul>
          </div>
          <div class="care-section" id="ai-exercise">
              <h3 class="icon-title"><i class="fa-solid fa-person-walking" style="color: #1976D2;"></i> Exercise & Activity</h3>
              <ul><li>Please run an assessment first.</li></ul>
          </div>
          <div class="care-section" id="ai-mind">
              <h3 class="icon-title"><i class="fa-solid fa-brain" style="color: #7a56eb);"></i> Stress & Mind</h3>
              <ul><li>Please run an assessment first.</li></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 5. AI Predictions (NEW DESIGN) -->
  <!-- MODIFIED: This page now represents the "Clinical Decision Layer" -->
  <div class="app-page" id="page-ai-predictions">
    <div class="app-header">
      <h1><i class="fa-solid fa-robot"></i> Clinical Decision Layer (AI Simulation)</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container" id="predictions-content">
      <div class="app-card">
        <p style="text-align: center; font-size: 1.1rem; color: #555;">The AI simulation analyzes your fused data to provide advanced insights. This is a simulation of the "Clinical Decision Layer" from your framework.</p>
        <div class="care-grid">
          <!-- MODIFIED: Replaced "Forecast" with "Anomaly Detection" -->
          <div class="care-section">
            <h3 class="icon-title"><i class="fa-solid fa-shield-heart" style="color: var(--risk-high-color);"></i> Anomaly Detection (Simulated)</h3>
            <p style="font-size: 0.9rem; margin-top: -10px; color: #555;">Simulates a GRU/Autoencoder model scanning for irregularities.</p>
            <ul id="ai-anomaly-list"><li>Please run an assessment first.</li></ul>
          </div>
          <!-- MODIFIED: Replaced "Scenarios" with "Risk Stratification" -->
          <div class="care-section">
            <h3 class="icon-title"><i class="fa-solid fa-layer-group" style="color: #1976D2;"></i> Risk Stratification (Simulated)</h3>
            <p style="font-size: 0.9rem; margin-top: -10px; color: #555;">Simulates AI classifying your risk against patient cohorts.</p>
            <ul id="ai-stratification-list"><li>Please run an assessment first.</li></ul>
          </div>
          <!-- MODIFIED: Replaced "Alerts" with "Adaptive Treatment" -->
          <div class="care-section">
            <h3 class="icon-title"><i class="fa-solid fa-pills" style="color: var(--risk-moderate-color);"></i> Adaptive Treatment (Simulated)</h3>
            <p style="font-size: 0.9rem; margin-top: -10px; color: #555;">Simulates real-time adjustments to your care plan.</p>
            <ul id="ai-treatment-list"><li>Please run an assessment first.</li></ul>
            <button class="contact-relative-btn" id="contact-relative-btn-2" style="display: none; margin-top: 20px; background-color: var(--risk-moderate-color);">
                <i class="fa-solid fa-mobile-screen-button"></i> Send SOP to Care Team
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 6. Clinical Reports -->
  <div class="app-page" id="page-clinical-reports">
    <div class="app-header">
      <h1><i class="fa-solid fa-file-invoice"></i> Automated Clinical Report</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container" id="report-page-content">
      <div class="app-card">
        <p>This is an auto-generated report based on the data from your last assessment. This can be shared with your care team.</p>
        <!-- NEW: Report UI changed from <pre> to a styled div -->
        <div id="report-content-wrapper">
            <pre id="report-content">Please run an assessment to generate your report.</pre>
        </div>
        <!-- NEW: QR Code Canvas -->
        <div id="qr-code-container" style="display: none;">
            <h3 style="color: var(--text-primary); text-align: center;">Scan QR Code for Full Report</h3>
            <canvas id="report-qr-code" style="display: block; margin: 0 auto;"></canvas>
        </div>
        <button class="download-btn" id="download-report-btn" disabled>
            <i class="fa-solid fa-download"></i> Download Report (.txt)
        </button>
      </div>
    </div>
  </div>

  <!-- 7. Telemedicine (NEW AI CHATBOT) -->
  <div class="app-page" id="page-telemedicine">
    <div class="app-header">
      <h1><i class="fa-solid fa-video"></i> Telemedicine Portal</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container">
      <div class="telemedicine-grid">
        <div class="app-card">
          <h2 class="card-title"><i class="fa-solid fa-video"></i> Video Consultation</h2>
          <!-- NEW: Live Video Placeholder -->
          <div class="video-placeholder" id="video-placeholder">
            <div id="remote-video-placeholder">
                <i class="fa-solid fa-video-slash"></i>
                <span id="video-status-text">Your video call has not started.</span>
            </div>
            <!-- This video element will show your local webcam -->
            <video id="local-video" autoplay playsinline muted></video>
            <div class="video-controls" id="video-controls">
                <button class="button primary" id="start-call-btn">Start Call</button>
                <button class="button secondary" id="end-call-btn" style="display: none; background-color: var(--risk-high-color);">End Call</button>
            </div>
          </div>
        </div>
        <div class="app-card">
          <h2 class="card-title"><i class="fa-solid fa-comments"></i> AI Chat with Dr. Manoj Kumar</h2>
          <div class="chat-box">
            <div class="chat-messages" id="chat-messages">
              <div class="chat-message bot">Hello! I'm Dr.Manoj Kumar , your AI cardiology assistant. How can I help you today?</div>
            </div>
            <form class="chat-input" id="chat-form">
              <input type="text" id="chat-input-text" placeholder="Type a message..." autocomplete="on" />
              <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 8. Electromechanical Heart Models -->
  <div class="app-page" id="page-heart-models">
    <div class="app-header">
      <h1><i class="fa-solid fa-heart-pulse"></i> Electromechanical Heart Models</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container">
      <div class="dashboard-grid">
        <div class="left-column">
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-microscope"></i> Electrophysiology Model</h2>
            <p>Advanced computational models integrating cardiac electrical activity, action potentials, and conduction pathways.</p>
            <div class="stats-grid" style="margin-top: 20px;">
              <div class="stat-item">
                <p id="ap-duration">--</p><h3>Action Potential</h3>
              </div>
              <div class="stat-item">
                <p id="conduction-vel">--</p><h3>Conduction Velocity</h3>
              </div>
            </div>
            <div style="position: relative;">
              <canvas id="electrophysiology-chart" style="height: 150px; margin-top: 20px;"></canvas>
              <button class="button secondary" onclick="downloadChartData('electrophysiology-chart', 'Electrophysiology')" style="position: absolute; top: 20px; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save Data
              </button>
            </div>
          </div>
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-tint"></i> Hemodynamics Model</h2>
            <p>Blood flow dynamics, pressure gradients, and vascular resistance modeling for comprehensive cardiovascular assessment.</p>
            <div class="stats-grid" style="margin-top: 20px;">
              <div class="stat-item">
                <p id="cardiac-output">--</p><h3>Cardiac Output</h3>
              </div>
              <div class="stat-item">
                <p id="ejection-fraction">--</p><h3>Ejection Fraction</h3>
              </div>
            </div>
            <div style="position: relative;">
              <canvas id="hemodynamics-chart" style="height: 150px; margin-top: 20px;"></canvas>
              <button class="button secondary" onclick="downloadChartData('hemodynamics-chart', 'Hemodynamics')" style="position: absolute; top: 20px; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save Data
              </button>
            </div>
          </div>
        </div>
        <div class="right-column">
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-cogs"></i> Mechanics Model</h2>
            <p>Cardiac mechanics including contractility, wall stress, and ventricular function analysis.</p>
            <div class="stats-grid" style="margin-top: 20px;">
              <div class="stat-item">
                <p id="contractility">--</p><h3>Contractility Index</h3>
              </div>
              <div class="stat-item">
                <p id="wall-stress">--</p><h3>Wall Stress</h3>
              </div>
            </div>
            <div style="position: relative;">
              <canvas id="mechanics-chart" style="height: 150px; margin-top: 20px;"></canvas>
              <button class="button secondary" onclick="downloadChartData('mechanics-chart', 'Mechanics')" style="position: absolute; top: 20px; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save Data
              </button>
            </div>
          </div>
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-cube"></i> 3D Heart Visualization</h2>
            <div id="heart-3d-container" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 12px; padding: 40px; text-align: center; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative;">
              
              <!-- 3D Heart Canvas Placeholder -->
              <canvas id="heart-3d-canvas" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></canvas>

              <div id="heart-3d-info" style="position: relative; z-index: 10;">
                <i class="fa-solid fa-heart" style="font-size: 5rem; color: var(--primary-color); margin-bottom: 20px; animation: heartbeat 1.5s ease-in-out infinite;"></i>
                <p style="color: #555; font-size: 1.1rem;">Interactive 3D heart model visualization</p>
                <p style="color: #888; font-size: 0.9rem; margin-top: 10px;">Integrating electrophysiology, hemodynamics, and mechanics</p>
              </div>
              
              <button class="submit-btn" style="margin-top: 20px; max-width: 300px;" onclick="startHeartSimulation()">
                <i class="fa-solid fa-play"></i> Start 3D Simulation
              </button>
              <button class="button secondary" style="margin-top: 10px; max-width: 300px; display: none;" id="stop-3d-btn" onclick="stopHeartSimulation()">
                <i class="fa-solid fa-stop"></i> Stop Simulation
              </button>
              <p id="simulation-status" style="font-size: 0.9rem; margin-top: 10px; font-weight: 600; color: var(--primary-color); display: none;"></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 9. Multimodal Data Fusion -->
  <div class="app-page" id="page-data-fusion">
    <div class="app-header">
      <h1><i class="fa-solid fa-layer-group"></i> Multimodal Data Fusion</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container">
      <div class="dashboard-grid full-width-grid">
        <div class="app-card">
          <h2 class="card-title"><i class="fa-solid fa-satellite-dish"></i> Data Sources Integration</h2>
          <div class="care-grid" style="margin-top: 20px;">
            <div class="care-section">
              <h3 class="icon-title"><i class="fa-solid fa-heartbeat" style="color: var(--primary-color);"></i> Wearable ECG</h3>
              <ul>
                <li>Real-time ECG data streaming</li>
                <li>Continuous monitoring integration</li>
                <li>Signal quality assessment</li>
                <li id="ecg-status">Status: <span style="color: var(--risk-low-color);">Connected</span></li>
              </ul>
            </div>
            <div class="care-section">
              <h3 class="icon-title"><i class="fa-solid fa-x-ray" style="color: #1976D2;"></i> MRI/CT Imaging</h3>
              <ul>
                <li>Medical imaging data fusion</li>
                <li>3D reconstruction from scans</li>
                <li>Anatomical structure mapping</li>
                <li id="imaging-status">Status: <span style="color: var(--risk-low-color);">Available</span></li>
              </ul>
            </div>
            <div class="care-section">
              <h3 class="icon-title"><i class="fa-solid fa-file-medical" style="color: var(--risk-moderate-color);"></i> Electronic Health Records (EHR)</h3>
              <ul>
                <li>HL7/FHIR compliant integration</li>
                <li>Historical data synchronization</li>
                <li>Cross-platform data sharing</li>
                <li id="ehr-status">Status: <span style="color: var(--risk-low-color);">Synchronized</span></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="app-card">
          <h2 class="card-title"><i class="fa-solid fa-network-wired"></i> Fusion Pipeline</h2>
          <div style="background: #fafafa; border-radius: 12px; padding: 30px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="text-align: center; flex: 1;">
                <i class="fa-solid fa-heartbeat" style="font-size: 2rem; color: var(--primary-color);"></i>
                <p style="margin-top: 10px; font-weight: 600;">ECG Data</p>
              </div>
              <i class="fa-solid fa-arrow-right" style="font-size: 1.5rem; color: #888; margin: 0 20px;"></i>
              <div style="text-align: center; flex: 1;">
                <i class="fa-solid fa-code-branch" style="font-size: 2rem; color: var(--ai-gradient-1);"></i>
                <p style="margin-top: 10px; font-weight: 600;">Fusion Engine</p>
              </div>
              <i class="fa-solid fa-arrow-right" style="font-size: 1.5rem; color: #888; margin: 0 20px;"></i>
              <div style="text-align: center; flex: 1;">
                <i class="fa-solid fa-chart-line" style="font-size: 2rem; color: var(--ai-gradient-2);"></i>
                <p style="margin-top: 10px; font-weight: 600;">Unified Model</p>
              </div>
            </div>
            <div style="position: relative;">
              <canvas id="fusion-chart" style="height: 180px; margin-top: 20px;"></canvas>
              <button class="button secondary" onclick="downloadChartData('fusion-chart', 'DataFusion')" style="position: absolute; top: 20px; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 10. Adaptive Models -->
  <div class="app-page" id="page-adaptive-models">
    <div class="app-header">
      <h1><i class="fa-solid fa-arrows-rotate"></i> Adaptive Models with Continuous Feedback</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container">
      <div class="dashboard-grid">
        <div class="left-column">
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-brain"></i> Model Evolution</h2>
            <p>Our adaptive models continuously learn and evolve based on patient feedback and new data inputs.</p>
            <div class="stats-grid" style="margin-top: 20px;">
              <div class="stat-item">
                <h3>Model Version</h3>
                <p id="model-version">v2.4.1</p>
              </div>
              <div class="stat-item">
                <h3>Training Iterations</h3>
                <p id="training-iterations">1,247</p>
              </div>
              <div class="stat-item">
                <h3>Accuracy</h3>
                <p id="model-accuracy">94.2%</p>
              </div>
              <div class="stat-item">
                <h3>Last Update</h3>
                <p id="last-update" style="font-size: 1rem;">2 hours ago</p>
              </div>
            </div>
            <div style="position: relative;">
              <canvas id="model-evolution-chart" style="height: 180px; margin-top: 20px;"></canvas>
              <button class="button secondary" onclick="downloadChartData('model-evolution-chart', 'ModelEvolution')" style="position: absolute; top: 20px; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save Data
              </button>
            </div>
          </div>
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-comments"></i> Feedback Loop</h2>
            <div style="background: #fafafa; border-radius: 12px; padding: 20px; margin-top: 20px;">
              <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <i class="fa-solid fa-check-circle" style="color: var(--risk-low-color); font-size: 1.5rem; margin-right: 15px;"></i>
                <div>
                  <p style="font-weight: 600; margin: 0;">Patient Feedback Integration</p>
                  <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">Real-time feedback processing</p>
                </div>
              </div>
              <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <i class="fa-solid fa-sync" style="color: var(--primary-color); font-size: 1.5rem; margin-right: 15px; animation: spin 2s linear infinite;"></i>
                <div>
                  <p style="font-weight: 600; margin: 0;">Continuous Learning</p>
                  <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">Model updates every 6 hours</p>
                </div>
              </div>
              <div style="display: flex; align-items: center;">
                <i class="fa-solid fa-chart-line" style="color: var(--ai-gradient-1); font-size: 1.5rem; margin-right: 15px;"></i>
                <div>
                  <p style="font-weight: 600; margin: 0;">Performance Monitoring</p>
                  <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">Tracking prediction accuracy</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="right-column">
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-sliders"></i> Model Parameters</h2>
            <div class="form-group">
              <label>Learning Rate <span class="slider-value" id="learning-rate-value">0.001</span></label>
              <input type="range" id="learning-rate" min="0.0001" max="0.01" step="0.0001" value="0.001">
            </div>
            <div class="form-group">
              <label>Feedback Weight <span class="slider-value" id="feedback-weight-value">0.75</span></label>
              <input type="range" id="feedback-weight" min="0" max="1" step="0.05" value="0.75">
            </div>
            <div class="form-group">
              <label>Update Frequency</label>
              <select id="update-frequency">
                <option value="realtime">Real-time</option>
                <option value="hourly">Hourly</option>
                <option value="daily" selected>Daily</option>
                <option value="weekly">Weekly</option>
              </select>
            </div>
            <button class="submit-btn" style="margin-top: 20px;">
              <i class="fa-solid fa-save"></i> Save Model Configuration
            </button>
          </div>
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-history"></i> Model History</h2>
            <div style="max-height: 300px; overflow-y: auto;">
              <div style="padding: 15px; border-bottom: 1px solid #eee;">
                <p style="font-weight: 600; margin: 0;">v2.4.1 - Current</p>
                <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">Updated 2 hours ago • Accuracy: 94.2%</p>
              </div>
              <div style="padding: 15px; border-bottom: 1px solid #eee;">
                <p style="font-weight: 600; margin: 0;">v2.4.0</p>
                <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">Updated 1 day ago • Accuracy: 93.8%</p>
              </div>
              <div style="padding: 15px; border-bottom: 1px solid #eee;">
                <p style="font-weight: 600; margin: 0;">v2.3.5</p>
                <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">Updated 3 days ago • Accuracy: 93.5%</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 11. ML Treatment Optimization -->
  <div class="app-page" id="page-ml-optimization">
    <div class="app-header">
      <h1><i class="fa-solid fa-brain"></i> ML Treatment Optimization</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container">
      <div class="dashboard-grid">
        <div class="left-column">
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-user-md"></i> Personalized Predictions</h2>
            <p>Advanced machine learning algorithms analyze patient data to generate personalized treatment recommendations.</p>
            <div class="care-grid" style="margin-top: 20px;">
              <div class="care-section">
                <h3 class="icon-title"><i class="fa-solid fa-pills" style="color: var(--primary-color);"></i> Medication Optimization</h3>
                <ul id="medication-recommendations">
                  <li>Analyzing patient profile...</li>
                </ul>
              </div>
              <div class="care-section">
                <h3 class="icon-title"><i class="fa-solid fa-dumbbell" style="color: var(--risk-low-color);"></i> Lifestyle Recommendations</h3>
                <ul id="lifestyle-recommendations">
                  <li>Analyzing patient profile...</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-chart-bar"></i> Treatment Efficacy Prediction</h2>
            <div style="position: relative;">
              <canvas id="treatment-efficacy-chart" style="height: 180px;"></canvas>
              <button class="button secondary" onclick="downloadChartData('treatment-efficacy-chart', 'TreatmentEfficacy')" style="position: absolute; top: 0; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save Data
              </button>
            </div>
          </div>
        </div>
        <div class="right-column">
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-robot"></i> ML Algorithm Performance</h2>
            <div class="stats-grid" style="margin-top: 20px;">
              <div class="stat-item">
                <h3>Random Forest</h3>
                <p style="color: var(--risk-low-color);">92.5%</p>
              </div>
              <div class="stat-item">
                <h3>Neural Network</h3>
                <p style="color: var(--risk-low-color);">94.2%</p>
              </div>
              <div class="stat-item">
                <h3>Gradient Boosting</h3>
                <p style="color: var(--risk-low-color);">91.8%</p>
              </div>
              <div class="stat-item">
                <h3>Ensemble Model</h3>
                <p style="color: var(--primary-color); font-weight: 700;">95.1%</p>
              </div>
            </div>
            <div style="position: relative;">
              <canvas id="ml-performance-chart" style="height: 180px; margin-top: 20px;"></canvas>
              <button class="button secondary" onclick="downloadChartData('ml-performance-chart', 'MLPerformance')" style="position: absolute; top: 20px; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save Data
              </button>
            </div>
          </div>
          <div class="app-card">
            <h2 class="card-title"><i class="fa-solid fa-lightbulb"></i> Treatment Plan Suggestions</h2>
            <div id="treatment-suggestions" style="margin-top: 20px;">
              <div style="padding: 15px; background: #f0f7ff; border-left: 4px solid var(--primary-color); border-radius: 8px; margin-bottom: 15px;">
                <p style="font-weight: 600; margin: 0 0 5px 0;">Primary Recommendation</p>
                <p style="color: #555; font-size: 0.95rem; margin: 0;">Optimize beta-blocker dosage based on heart rate variability analysis.</p>
              </div>
              <div style="padding: 15px; background: #fff5e6; border-left: 4px solid var(--risk-moderate-color); border-radius: 8px; margin-bottom: 15px;">
                <p style="font-weight: 600; margin: 0 0 5px 0;">Secondary Recommendation</p>
                <p style="color: #555; font-size: 0.95rem; margin: 0;">Increase physical activity gradually with monitored intensity.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 12. Secure Data Management -->
  <div class="app-page" id="page-data-management">
    <div class="app-header">
      <h1><i class="fa-solid fa-shield-halved"></i> Secure Data Management</h1>
      <button class="back-btn">Back to Home</button>
    </div>
    <div class="app-container">
      <div class="dashboard-grid full-width-grid">
        <div class="app-card">
          <h2 class="card-title"><i class="fa-solid fa-shield"></i> HIPAA Compliance</h2>
          <div class="care-grid" style="margin-top: 20px;">
            <div class="care-section">
              <h3 class="icon-title"><i class="fa-solid fa-lock" style="color: var(--risk-low-color);"></i> Data Encryption</h3>
              <ul>
                <li>AES-256 encryption at rest</li>
                <li>TLS 1.3 encryption in transit</li>
                <li>End-to-end encryption for sensitive data</li>
                <li>Regular security audits and updates</li>
              </ul>
            </div>
            <div class="care-section">
              <h3 class="icon-title"><i class="fa-solid fa-user-shield" style="color: var(--primary-color);"></i> Access Control</h3>
              <ul>
                <li>Role-based access control (RBAC)</li>
                <li>Multi-factor authentication (MFA)</li>
                <li>Audit logs for all data access</li>
                <li>Minimum necessary access principle</li>
              </ul>
            </div>
            <div class="care-section">
              <h3 class="icon-title"><i class="fa-solid fa-file-contract" style="color: var(--risk-moderate-color);"></i> Compliance Standards</h3>
              <ul>
                <li>HIPAA compliant infrastructure</li>
                <li>GDPR compliance for international data</li>
                <li>HITECH Act compliance</li>
                <li>Regular compliance certifications</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="app-card">
          <h2 class="card-title"><i class="fa-solid fa-cloud"></i> Scalable Architecture</h2>
          <div style="background: #fafafa; border-radius: 12px; padding: 30px; margin-top: 20px;">
            <div class="stats-grid" style="margin-bottom: 20px;">
              <div class="stat-item">
                <h3>Data Storage</h3>
                <p style="color: var(--primary-color);">2.4 PB</p>
              </div>
              <div class="stat-item">
                <h3>Active Patients</h3>
                <p style="color: var(--primary-color);">125K+</p>
              </div>
              <div class="stat-item">
                <h3>Uptime</h3>
                <p style="color: var(--risk-low-color);">99.99%</p>
              </div>
              <div class="stat-item">
                <h3>Response Time</h3>
                <p style="color: var(--risk-low-color);">< 50ms</p>
              </div>
            </div>
            <div style="margin-top: 20px;">
              <h3 style="margin-bottom: 15px;">Infrastructure Components</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #eee;">
                  <i class="fa-solid fa-database" style="color: var(--primary-color); font-size: 1.5rem; margin-bottom: 10px;"></i>
                  <p style="font-weight: 600; margin: 0;">Distributed Database</p>
                  <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">PostgreSQL + Redis</p>
                </div>
                <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #eee;">
                  <i class="fa-solid fa-server" style="color: var(--ai-gradient-1); font-size: 1.5rem; margin-bottom: 10px;"></i>
                  <p style="font-weight: 600; margin: 0;">Cloud Infrastructure</p>
                  <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">AWS/Azure/GCP</p>
                </div>
                <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #eee;">
                  <i class="fa-solid fa-network-wired" style="color: var(--ai-gradient-2); font-size: 1.5rem; margin-bottom: 10px;"></i>
                  <p style="font-weight: 600; margin: 0;">Load Balancing</p>
                  <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">Auto-scaling enabled</p>
                </div>
                <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #eee;">
                  <i class="fa-solid fa-backup" style="color: var(--risk-low-color); font-size: 1.5rem; margin-bottom: 10px;"></i>
                  <p style="font-weight: 600; margin: 0;">Backup & Recovery</p>
                  <p style="color: #888; font-size: 0.9rem; margin: 5px 0 0 0;">Daily automated backups</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="app-card">
          <h2 class="card-title"><i class="fa-solid fa-chart-line"></i> System Health Monitoring</h2>
          <div style="position: relative;">
            <canvas id="system-health-chart" style="height: 180px; margin-top: 20px;"></canvas>
            <button class="button secondary" onclick="downloadChartData('system-health-chart', 'SystemHealth')" style="position: absolute; top: 20px; right: 10px; padding: 5px 10px; font-size: 0.8rem;">
                <i class="fa-solid fa-download"></i> Save Data
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div> <!-- End #app-page-wrapper -->


<!-- Warning Message for disabled pages -->
<div class="assessment-warning" id="assessment-warning-template" style="display: none;">
    <i class="fa-solid fa-triangle-exclamation"></i>
    <p>Please run an assessment first.</p>
    <p>Go to the <strong>Patient & Sensors Layer</strong> page to enter your data and generate your personalized report.</p>
    <button class="go-to-form-btn">Go to Assessment Form</button>
</div>

<!-- NEW: High Risk Alarm Modal -->
<div class="alarm-modal-overlay" id="alarm-modal">
    <div class="alarm-modal-content">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <h1>HIGH RISK DETECTED</h1>
        <p>Your assessment indicates a HIGH RISK for a cardiac event. Please stay calm and follow your emergency protocol.</p>
        <button class="alarm-btn sop-btn" id="alarm-send-sms-btn">
            <i class="fa-brands fa-whatsapp"></i> SEND ALERT VIA WHATSAPP
        </button>
        <button class="alarm-btn dismiss-btn" id="alarm-dismiss-btn">
            <i class="fa-solid fa-check"></i> I Acknowledge
        </button>
    </div>
</div>

<!-- NEW: SMS/WhatsApp Simulation Modal -->
<div class="sms-modal-overlay" id="sms-modal">
    <div class="sms-modal-content">
        <h2><i class="fa-solid fa-paper-plane" style="color: var(--primary-color); margin-right: 10px;"></i>Send Emergency Alert</h2>
        <div class="form-group">
            <label for="sms-phone">Relative's Phone Number</label>
            <input type="text" id="sms-phone" value="+919529292990">
        </div>
        <div class="form-group">
            <label for="sms-message">Message (AI-Generated SOP)</label>
            <textarea id="sms-message" rows="6"></textarea>
        </div>
        <div class="sms-modal-actions">
            <button class="button secondary" id="sms-cancel-btn">Cancel</button>
            <button class="button primary" id="sms-send-btn"><i class="fa-brands fa-whatsapp"></i> Send (Open WhatsApp)</button>
        </div>
    </div>
</div>

<!-- This audio element is used for the alarm sound -->
<audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
<!-- NEW: ECG Beep Sound -->
<audio id="ecg-beep-sound" src="https://actions.google.com/sounds/v1/medical/ecg_beep.ogg" preload="auto"></audio>


<script>
  // --- Original Slider Script ---
  const pills = document.querySelectorAll('.pill');
  const cardsContainer = document.querySelector('.cards');
  const arrowLeft = document.querySelector('.arrow-left');
  const arrowRight = document.querySelector('.arrow-right');

  pills.forEach((pill, i) => {
    pill.addEventListener('click', () => {
      pills.forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      cardsContainer.children[i].scrollIntoView({behavior: 'smooth', inline: 'center'});
    });
  });

  const scrollAmount = 340; 
  arrowRight.addEventListener('click', () => {
    cardsContainer.scrollBy({left: scrollAmount, behavior: 'smooth'});
  });
  arrowLeft.addEventListener('click', () => {
    cardsContainer.scrollBy({left: -scrollAmount, behavior: 'smooth'});
  });

  function checkArrows() {
    arrowLeft.disabled = cardsContainer.scrollLeft <= 0;
    arrowRight.disabled = cardsContainer.scrollLeft + cardsContainer.clientWidth >= cardsContainer.scrollWidth - 1;
  }
  cardsContainer.addEventListener('scroll', checkArrows);
  window.addEventListener('resize', checkArrows);
  checkArrows();

  
  /* ==============================================
  == JAVASCRIPT FOR FULL-SCREEN APP PAGES ==
  ==============================================
  */

  // --- Page Navigation ---
  const mainLandingPage = document.getElementById('main-landing-page');
  const appPageWrapper = document.getElementById('app-page-wrapper');
  const appPages = document.querySelectorAll('.app-page');
  const allPills = document.querySelectorAll('.pill');
  const allTryButtons = document.querySelectorAll('.btn-try');
  const backButtons = document.querySelectorAll('.back-btn');
  const patientSearchForm = document.getElementById('patient-search-form');
  const patientIdSearchInput = document.getElementById('patient-id-search');

  function showPage(pageId) {
    mainLandingPage.style.display = 'none';
    appPageWrapper.style.display = 'block';
    
    // Stop any running ECG interval from the ECG page
    if (ecgInterval) {
        clearInterval(ecgInterval);
        ecgInterval = null;
    }

    appPages.forEach(page => {
      page.style.display = 'none';
    });
    
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
      targetPage.style.display = 'block';
    }

    // --- Check if data has been assessed ---
    const pagesNotRequiringAssessment = ['page-heart-rate', 'page-telemedicine', 'page-heart-models', 'page-data-fusion', 'page-adaptive-models', 'page-ml-optimization', 'page-data-management'];
    if (!currentDecision && !pagesNotRequiringAssessment.includes(pageId)) {
      const container = document.querySelector(`#${pageId} .app-container`);
      // Restore original content if it was replaced by a warning
      if (originalPageContent[pageId] && !container.querySelector('.app-card') && !container.querySelector('.dashboard-grid') && !container.querySelector('.risk-score-grid')) {
         container.innerHTML = originalPageContent[pageId];
      }
      
      const warningTemplate = document.getElementById('assessment-warning-template').cloneNode(true);
      warningTemplate.style.display = 'block';
      warningTemplate.id = '';
      warningTemplate.querySelector('.go-to-form-btn').addEventListener('click', () => showPage('page-heart-rate'));
      
      container.innerHTML = ''; // Clear the content
      container.appendChild(warningTemplate);
      return;
    }

    // --- If data EXISTS, update the page ---
    if (currentDecision) {
      // Restore original content if it was replaced by a warning
      const container = document.querySelector(`#${pageId} .app-container`);
      if (originalPageContent[pageId] && !container.querySelector('.app-card') && !container.querySelector('.dashboard-grid') && !container.querySelector('.risk-score-grid') && !container.querySelector('.telemedicine-grid')) {
         container.innerHTML = originalPageContent[pageId];
      }

      if (pageId === 'page-ecg') {
        startECGChart(); // This will create and resize the chart
        updateECGVitals(currentDecision.vitals, 'ecg');
      }
      if (pageId === 'page-risk-score') {
        updateRiskScorePage(currentDecision); // This will create and resize charts
      }
      if (pageId === 'page-personalized-care') {
        updatePersonalizedCare(currentDecision);
      }
      if (pageId === 'page-ai-predictions') {
        // MODIFIED: This function now updates the "Clinical Decision Layer"
        updateAIPredictions(currentDecision);
      }
      if (pageId === 'page-clinical-reports') {
        updateClinicalReport(currentDecision);
      }
    }
    
    // Initialize new pages (these functions now handle resize)
    if (pageId === 'page-heart-models') {
      initializeHeartModels();
    }
    if (pageId === 'page-data-fusion') {
      initializeDataFusion();
    }
    if (pageId === 'page-adaptive-models') {
      initializeAdaptiveModels();
    }
    if (pageId === 'page-ml-optimization') {
      initializeMLOptimization();
    }
    if (pageId === 'page-data-management') {
      initializeDataManagement();
    }
  }

  function showHomePage() {
    appPageWrapper.style.display = 'none';
    mainLandingPage.style.display = 'block';
    appPages.forEach(page => {
      page.style.display = 'none';
    });
    // Stop ECG chart when going home
    if (ecgInterval) {
        clearInterval(ecgInterval);
        ecgInterval = null;
    }
    // Stop video call when going home
    stopVideoCall();
    // Stop 3D simulation when going home
    stopHeartSimulation();
  }
  
  // Store original page content to restore it after warning
  const originalPageContent = {};
  appPages.forEach(page => {
      if (page.id !== 'page-heart-rate' && page.id !== 'page-telemedicine') {
          originalPageContent[page.id] = document.querySelector(`#${page.id} .app-container`).innerHTML;
      }
  });


  allPills.forEach(pill => {
    pill.addEventListener('click', () => {
      const pageId = pill.dataset.page;
      showPage(pageId);
    });
  });

  allTryButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      e.preventDefault();
      const pageId = button.dataset.page;
      showPage(pageId);
    });
  });

  backButtons.forEach(button => {
    button.addEventListener('click', () => {
      showHomePage();
    });
  });

  // --- NEW: Patient Search Function ---
  patientSearchForm.onsubmit = (e) => {
      e.preventDefault();
      const searchId = patientIdSearchInput.value.trim().toUpperCase();
      if (searchId === '') return;
      
      const foundAssessment = assessments.find(assessment => assessment.id === searchId);
      
      if (foundAssessment) {
          currentDecision = foundAssessment;
          updateFeedbackLayer(foundAssessment, false); // Update all data, but don't re-save
          showPage('page-risk-score'); // Show result
          patientIdSearchInput.value = '';
      } else {
          alert(`Patient ID "${searchId}" not found in local records. Please run a new assessment.`);
      }
  };


  // --- 4-Layer Framework (Inside the App Pages) ---

  let assessments = []; // In-memory database
  let currentId = 1000; // Start Patient IDs at 1000
  let currentDecision = null;

  // *** REWRITE NOTE ***: 
  // We no longer need to store chart instances in global variables like `ecgChart`, `riskDistChart`, etc.
  // We will use Chart.getChart(id) to find them. This is cleaner.
  // The *exception* is ecgInterval, which we still need to control.
  let ecgInterval;
  let localMediaStream; // For video call
  let cameraStream; // For HR detection

  const form = document.getElementById('risk-form');
  
  const patientNameInput = document.getElementById('patient-name');
  const genderInput = document.getElementById('gender');
  const ageInput = document.getElementById('age');
  const cpInput = document.getElementById('cp');
  const thalachInput = document.getElementById('thalach');
  const oldpeakInput = document.getElementById('oldpeak');
  const thalInput = document.getElementById('thal');

  const ageValue = document.getElementById('age-value');
  const thalachValue = document.getElementById('thalach-value');
  const oldpeakValue = document.getElementById('oldpeak-value');

  const totalAssessmentsDisplay = document.querySelector('#total-assessments p');
  const avgRiskDisplay = document.querySelector('#avg-risk p');
  const lastAssessmentDisplay = document.querySelector('#last-assessment p');
  
  const reportContent = document.getElementById('report-content');
  const downloadReportBtn = document.getElementById('download-report-btn');
  
  const liveVitalsCard = document.getElementById('live-vitals-dashboard');
  
  // Alarm Modal Elements
  const alarmModal = document.getElementById('alarm-modal');
  const alarmSound = document.getElementById('alarm-sound');
  const alarmDismissBtn = document.getElementById('alarm-dismiss-btn');
  const alarmSmsBtn = document.getElementById('alarm-send-sms-btn');
  
  // SMS Modal Elements
  const smsModal = document.getElementById('sms-modal');
  const smsCancelBtn = document.getElementById('sms-cancel-btn');
  const smsSendBtn = document.getElementById('sms-send-btn');
  const smsPhoneInput = document.getElementById('sms-phone');
  const smsMessageInput = document.getElementById('sms-message');
  
  // Contact Relative Buttons
  const contactBtn1 = document.getElementById('contact-relative-btn-1');
  const contactBtn2 = document.getElementById('contact-relative-btn-2');
  
  // ECG Beep Sound
  const ecgBeepSound = document.getElementById('ecg-beep-sound');
  
  // Camera HR Elements
  const cameraBtn = document.getElementById('camera-hr-btn');
  const cameraFeed = document.getElementById('camera-feed');
  const cameraStatus = document.getElementById('camera-status');

  ageInput.oninput = () => ageValue.textContent = ageInput.value;
  thalachInput.oninput = () => thalachValue.textContent = thalachInput.value;
  oldpeakInput.oninput = () => oldpeakValue.textContent = oldpeakInput.value;

  form.onsubmit = async function(event) {
      event.preventDefault(); 
      
      const submitBtn = form.querySelector('.submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Assessing...';
      
      // LAYER 1: Patient & Sensors Layer
      const layer1Data = getSimulatedSensorData();
      // LAYER 2: Data Management Layer (Simulation)
      const layer2Data = manageAndSendData(layer1Data);
      
      // LAYER 3 (Part 1): Local Risk Model
      let decision = runRiskModel(layer2Data);
      
      // Show loading state in UI
      const placeholder = ["AI is generating recommendations..."];
      updatePersonalizedCare({ carePlan: { diet: placeholder, exercise: placeholder, mind: placeholder } });
      updateAIPredictions({ anomalyDetection: placeholder, riskStratification: placeholder, adaptiveTreatment: placeholder });

      // LAYER 3 (Part 2): AI Clinical Decision Layer (Simulation)
      const aiPredictions = await getAIPredictions(decision);
      
      // Merge local risk score with AI-generated decisions
      decision = { ...decision, ...aiPredictions };
      
      currentDecision = decision;
      
      // LAYER 4: Feedback Layer (Update UI)
      updateFeedbackLayer(currentDecision, true); // Save new assessment
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Assess Risk & View Score';
      
      // Auto-switch to the Risk Score page
      showPage('page-risk-score');
  };
  
  
  // --- LAYER 1 FUNCTION ---
  function getSimulatedSensorData() {
      // This simulates data collection from the "Patient & Sensors Layer"
      return {
          name: patientNameInput.value || "Anonymous",
          gender: genderInput.value,
          age: parseInt(ageInput.value),
          cp: parseInt(cpInput.value),
          cpText: cpInput.options[cpInput.selectedIndex].text,
          thalach: parseFloat(thalachInput.value),
          oldpeak: parseFloat(oldpeakInput.value),
          thal: parseInt(thalInput.value),
          thalText: thalInput.options[thalInput.selectedIndex].text,
      };
  }

  // --- LAYER 2 FUNCTION ---
  function manageAndSendData(data) {
      // This simulates the "Data Management Layer"
      // (Preprocessing, Fusion, Secure Storage)
      const now = new Date();
      const timestamp = now.toISOString().split('T')[0] + ' ' + 
                        now.toTimeString().split(' ')[0];
      return {
          id: `PID-${currentId++}`, // New Patient ID
          timestamp: timestamp,
          ...data
      };
  }

  // --- LAYER 3 FUNCTION (AI Model) ---
  // This is the FAST, local model for risk score
  function runRiskModel(data) {
      // This is part of the "Clinical Decision Layer"
      // NEW Risk Model: Base 10, max 100
      let score = 10; 
      
      if (data.age > 50) score += (data.age - 50) * 0.5;
      if (data.cp === 0) score += 20; // Typical Angina is high risk
      if (data.cp === 1) score += 15;
      if (data.cp === 2) score += 10;
      if (data.thalach < 100) score += 20;
      else if (data.thalach < 130) score += 10;
      score += data.oldpeak * 15; // ST depression is a strong indicator
      if (data.thal === 3) score += 20; // Reversible Defect is high risk
      if (data.thal === 2) score += 10;

      let riskScore = Math.min(Math.max(Math.round(score), 10), 100);
      
      let riskCategory, riskClass;
      let bpm_base = (riskScore > 70) ? 95 : (riskScore > 40) ? 80 : 65;
      const vitals = {
        bpm: (bpm_base + Math.floor(Math.random() * 10)),
        pr: (160 + Math.floor(Math.random() * 40)),
        rr: (550 + Math.floor(Math.random() * 200)),
        tm: (0.4 + (Math.random() * 0.1)).toFixed(2)
      };

      // NEW Risk Categories: 10-39 (Low), 40-69 (Moderate), 70-100 (High)
      if (riskScore >= 70) {
          riskCategory = 'HIGH RISK';
          riskClass = 'risk-high';
      } else if (riskScore >= 40) {
          riskCategory = 'MODERATE RISK';
          riskClass = 'risk-moderate';
      } else {
          riskCategory = 'LOW RISK';
          riskClass = 'risk-low';
      }

      return {
          ...data,
          riskScore: riskScore,
          riskCategory: riskCategory,
          riskClass: riskClass,
          vitals: vitals,
      };
  }

  // --- MODIFIED: LAYER 3 (Async AI Clinical Decision Layer) ---
  async function getAIPredictions(decision) {
      const { riskScore, riskCategory, age, gender, cpText, oldpeak, thalach } = decision;

      // MODIFIED: This prompt now simulates the advanced models from your framework
      const systemPrompt = `You are the AI "Clinical Decision Layer" of a sophisticated cardiac framework.
      A patient has just received a risk assessment.
      Patient Data:
      - Risk Score: ${riskScore}
      - Risk Category: ${riskCategory}
      - Age: ${age}, Gender: ${gender}
      - Chest Pain: ${cpText}
      - Max Heart Rate: ${thalach}
      - ST Depression (oldpeak): ${oldpeak}

      Your task is to generate a JSON object with four keys: "anomalyDetection", "riskStratification", "adaptiveTreatment", and "carePlan".
      
      1.  "anomalyDetection": Simulate the findings of a GRU/Autoencoder model. Give 1-2 short sentences. (e.g., "No significant anomalous patterns detected in ECG data." or "Minor arrhythmia detected, consistent with risk profile.")
      2.  "riskStratification": Simulate how AI would stratify this patient. Give 1-2 short sentences. (e.g., "Patient stratified into 'Tier 3 (Moderate)' cohort. Recommend 6-month follow-up." or "Patient stratified into 'Tier 1 (High Priority)' cohort. Immediate clinical review required.")
      3.  "adaptiveTreatment": Simulate a real-time treatment recommendation. Give 1-2 short, actionable sentences. (e.g., "Maintain current medication. Increase monitoring frequency." or "Recommend immediate consultation to discuss adjusting beta-blocker dosage.")
      4.  "carePlan": An object with three keys: "diet", "exercise", and "mind". Each key should be an array of short, actionable recommendation strings for the "Personalized Care" page.

      Tailor all 4 responses directly to the patient's risk category.
      - If HIGH RISK: Be direct, urgent, and clinical.
      - If MODERATE RISK: Be encouraging but firm about the need for changes and monitoring.
      - If LOW RISK: Be positive and reinforcing.
      `;
      
      const apiKey = ""; // API key is handled by the environment
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

      try {
          const payload = {
              contents: [{ parts: [{ text: "Generate the Clinical Decision Layer JSON for this patient." }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              generationConfig: {
                  responseMimeType: "application/json",
                  // *** FIX ***: Corrected missing quote in 'riskStratification' type definition
                  responseSchema: {
                      type: "OBJECT",
                      properties: {
                          "anomalyDetection": { "type": "ARRAY", "items": { "type": "STRING" } },
                          "riskStratification": { "type": "ARRAY", "items": { "type": "STRING" } },
                          "adaptiveTreatment": { "type": "ARRAY", "items": { "type": "STRING" } },
                          "carePlan": {
                              type: "OBJECT",
                              properties: {
                                  "diet": { "type": "ARRAY", "items": { "type": "STRING" } },
                                  "exercise": { "type": "ARRAY", "items": { "type": "STRING" } },
                                  "mind": { "type": "ARRAY", "items": { "type": "STRING" } }
                              }
                          }
                      }
                  }
              }
          };

          const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });

          if (!response.ok) throw new Error(`API error: ${response.statusText}`);
          const result = await response.json();
          const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
          
          if(jsonText) {
              return JSON.parse(jsonText);
          } else {
              throw new Error("No valid JSON response from AI.");
          }

      } catch (error) {
          console.error("AI Predictions Error:", error);
          // MODIFIED: Fallback uses the new keys
          return {
              anomalyDetection: ["Could not connect to AI. Using local data."],
              riskStratification: ["Please check your internet connection and try again."],
              adaptiveTreatment: ["Using default recommendations."],
              carePlan: getCarePlan(decision.riskCategory) // Use local fallback
          };
      }
  }
  
  // Local fallback for care plan (unchanged)
  function getCarePlan(riskCategory) {
      if (riskCategory === 'HIGH RISK') {
          return {
              diet: ["URGENT: Immediately reduce sodium (<1,500mg/day). Avoid all processed foods.", "Focus on potassium-rich foods (bananas, spinach).", "No caffeine or stimulants."],
              exercise: ["Consult a doctor before starting any exercise.", "If cleared, gentle 5-10 minute walks are the maximum recommended."],
              mind: ["Practice 10-15 minutes of guided meditation daily.", "Ensure 7-8 hours of quality sleep.", "Contact your care team immediately if you feel dizzy."]
          };
      } else if (riskCategory === 'MODERATE RISK') {
          return {
              diet: ["Adopt a Mediterranean or DASH diet.", "Replace red meat with fish (salmon, mackerel) twice a week.", "Increase fruit, vegetable, and whole grain intake."],
              exercise: ["Aim for 30-45 minutes of moderate exercise 3-4 times a week (brisk walking, cycling).", "Incorporate light strength training."],
              mind: ["Practice 5-10 minutes of mindfulness daily.", "Take short walks in nature to de-stress."]
          };
      } else { // LOW RISK
          return {
              diet: ["Continue eating a balanced, whole-food diet.", "Monitor sodium intake to keep it below 2,300mg/day.", "Stay well-hydrated with water."],
              exercise: ["Maintain a regular exercise routine (150 minutes/week of moderate activity).", "Include activities you enjoy to stay consistent."],
              mind: ["Continue stress-management practices.", "Maintain strong social connections."]
          };
      }
  }

  
  // --- LAYER 4 FUNCTION (Update UI) ---
  function updateFeedbackLayer(decision, save = true) {
      if (save) {
        // Add to history and save to localStorage
        // Make sure assessments list exists
        if (!Array.isArray(assessments)) {
            assessments = [];
        }
        assessments.unshift(decision);
        localStorage.setItem('cardioAssessments', JSON.stringify(assessments));
      }
      
      // Update all parts of the UI
      updateStats();
      
      // Show and update the Live Vitals card on the dashboard
      liveVitalsCard.style.display = 'block';
      updateECGVitals(decision.vitals, 'dash');

      downloadReportBtn.disabled = false;
      
      // Show/hide relative contact buttons
      if (decision.riskClass === 'risk-high' || decision.riskClass === 'risk-moderate') {
          contactBtn1.style.display = 'block';
          contactBtn2.style.display = 'block';
      } else {
          contactBtn1.style.display = 'none';
          contactBtn2.style.display = 'none';
      }
      
      if (decision.riskClass === 'risk-high' && save) { // Only trigger alarm on new high risk
          triggerAlarm(decision);
      }
  }
  
  function updateStats() {
      totalAssessmentsDisplay.textContent = assessments.length;
      if (assessments.length > 0) {
        lastAssessmentDisplay.textContent = assessments[0].timestamp.split(' ')[0];
        const totalRisk = assessments.reduce((sum, item) => sum + item.riskScore, 0);
        const avgRisk = (totalRisk / assessments.length).toFixed(1);
        avgRiskDisplay.textContent = `${avgRisk}%`;
        
        // NEW: Update Historical Risk Chart
        updateHistoricalRiskChart();
      } else {
        lastAssessmentDisplay.textContent = 'N/A';
        avgRiskDisplay.textContent = '0.0%';
      }
  }

  // --- Chart Functions ---
  function startECGChart() {
      const ecgCanvas = document.getElementById('ecgChart');
      if (!ecgCanvas || typeof Chart === 'undefined') return;
      
      // *** REWRITE FIX ***: Destroy previous chart if it exists, using the modern API
      let existingChart = Chart.getChart(ecgCanvas);
      if (existingChart) {
          existingChart.destroy();
      }

      const data = {
          labels: Array(150).fill(''),
          datasets: [{
              label: 'ECG',
              data: [],
              borderColor: '#00ff00', // NEW: Green ECG line
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.4,
              // NEW: Green glow
              shadowColor: 'rgba(0, 255, 0, 0.5)',
              shadowBlur: 10,
          }]
      };
      const config = {
          type: 'line',
          data: data,
          options: {
              animation: false,
              scales: { y: { display: false, min: -1.5, max: 2.5 }, x: { display: false } },
              plugins: { legend: { display: false } },
              maintainAspectRatio: false
          }
      };
      
      const ecgChartInstance = new Chart(ecgCanvas, config);

      // *** REWRITE FIX ***: Add a resize delay to fix rendering
      setTimeout(() => {
          if (Chart.getChart(ecgCanvas)) { // Check if it still exists
              Chart.getChart(ecgCanvas).resize();
          }
      }, 100);

      let ecgData = [0, 0.1, 0.1, 0, -0.1, -0.3, -0.2, 0, 0.2, 0.4, 1.8, 0.5, 0.1, 0, 0, -0.1, -0.1, 0, 0, 0, 0, 0, 0, 0, 0.3, 0.3, 0.3, 0.3, 0, 0.1, 0.1, 0];
      let i = 0;
      
      if (ecgInterval) clearInterval(ecgInterval); // Clear any old interval

      ecgInterval = setInterval(() => {
          // *** REWRITE FIX ***: Check if the chart instance still exists, not the page display.
          // This interval is cleared when showPage() is called, so this check is robust.
          const currentChart = Chart.getChart(ecgCanvas);
          if (!currentChart) {
              clearInterval(ecgInterval);
              ecgInterval = null;
              return;
          }
          
          if (currentChart.data.datasets[0].data.length > 150) {
              currentChart.data.datasets[0].data.shift();
          }
          // NEW: Play beep sound on peak
          const currentPoint = ecgData[i % ecgData.length];
          if(currentPoint === 1.8) {
              ecgBeepSound.currentTime = 0;
              ecgBeepSound.play().catch(e => console.log("Audio play failed (user interaction needed)"));
          }
          currentChart.data.datasets[0].data.push(currentPoint);
          i++;
          currentChart.update();
      }, 60);
  }

  document.getElementById('start-ecg-btn').addEventListener('click', startECGChart);
  document.getElementById('stop-ecg-btn').addEventListener('click', () => {
      if (ecgInterval) clearInterval(ecgInterval);
      ecgInterval = null;
  });
  
  // NEW: Download ECG button
  document.getElementById('download-ecg-btn').addEventListener('click', () => {
      // *** REWRITE FIX ***: Use modern API
      const ecgChartInstance = Chart.getChart('ecgChart');
      if(ecgChartInstance) {
          const url = ecgChartInstance.toBase64Image();
          const link = document.createElement('a');
          link.download = `CardioFusion_ECG_Report_${currentDecision?.id || 'current'}.png`;
          link.href = url;
          link.click();
      } else {
          alert("Please start monitoring to generate an ECG graph first.");
      }
  });
  
  function updateECGVitals(vitals, prefix) {
      if(!document.getElementById(`vital-bpm-${prefix}`)) return;
      
      document.getElementById(`vital-bpm-${prefix}`).textContent = vitals.bpm;
      document.getElementById(`vital-pr-${prefix}`).textContent = vitals.pr;
      document.getElementById(`vital-rr-${prefix}`).textContent = vitals.rr;
      document.getElementById(`vital-tm-${prefix}`).textContent = vitals.tm;
      
      const vitalsGrid = document.getElementById(`vitals-grid-${prefix}`);
      if (vitalsGrid && currentDecision) { // Add check for currentDecision
        vitalsGrid.className = `stats-grid vitals-${currentDecision.riskClass}`;
      }
  }

  function updateRiskScorePage(decision) {
      const { riskScore, riskCategory, riskClass } = decision;
      
      const scoreValue = document.getElementById('risk-score-value');
      const scoreCategory = document.getElementById('risk-score-category');
      
      scoreValue.textContent = `${riskScore}%`;
      scoreCategory.textContent = riskCategory;
      
      scoreValue.className = `score ${riskClass}`;
      scoreCategory.className = `category ${riskClass}`;
      
      document.getElementById('factor-age').textContent = decision.age;
      document.getElementById('factor-cp').textContent = decision.cpText;
      document.getElementById('factor-thalach').textContent = decision.thalach;
      document.getElementById('factor-oldpeak').textContent = decision.oldpeak;

      updateRiskDistributionChart(riskScore, riskClass);
      updatePatientCohortTable(decision); // NEW
  }
  
  function updateRiskDistributionChart(score, riskClass) {
      const distCanvas = document.getElementById('riskDistributionChart');
      if (!distCanvas || typeof Chart === 'undefined') return;

      // *** REWRITE FIX ***: Destroy previous chart
      let existingChart = Chart.getChart(distCanvas);
      if (existingChart) {
          existingChart.destroy();
      }
      
      let barColors = [
          'rgba(56, 142, 60, 0.7)',
          'rgba(245, 124, 0, 0.7)',
          'rgba(211, 47, 47, 0.7)'
      ];
      let highlightColors = [
          'rgba(56, 142, 60, 1)',
          'rgba(245, 124, 0, 1)',
          'rgba(211, 47, 47, 1)'
      ];
      
      let userCategoryIndex = 0;
      if (riskClass === 'risk-moderate') userCategoryIndex = 1;
      if (riskClass === 'risk-high') userCategoryIndex = 2;
      
      const backgroundColors = barColors.map((color, index) => index === userCategoryIndex ? highlightColors[index] : color);

      const data = {
          labels: ['Low Risk (10-39)', 'Moderate Risk (40-69)', 'High Risk (70-100)'],
          datasets: [{
              label: 'Population Risk Distribution',
              data: [35, 45, 20],
              backgroundColor: backgroundColors,
              borderColor: highlightColors,
              borderWidth: 2
          }]
      };
      
      const config = {
          type: 'bar',
          data: data,
          options: {
              indexAxis: 'y',
              animation: false, // Disable animation for stability
              scales: {
                  x: { max: 100, ticks: { callback: (value) => value + '%' } }
              },
              plugins: { 
                  legend: { display: false },
                  tooltip: { enabled: false }
              }
          }
      };
      
      const riskDistChartInstance = new Chart(distCanvas, config);
      
      // *** REWRITE FIX ***: Add resize delay
      setTimeout(() => {
          if (Chart.getChart(distCanvas)) {
              Chart.getChart(distCanvas).resize();
          }
      }, 100);
  }

  // NEW: Patient Cohort Table
  function updatePatientCohortTable(currentUserDecision) {
      const tableBody = document.getElementById('patient-cohort-table');
      if (!tableBody) return;
      
      // Generate 20 mock patients
      const firstNames = ['John', 'Jane', 'Alex', 'Emily', 'Chris', 'Michael', 'Sarah', 'David', 'Laura', 'Robert'];
      const lastNames = ['Smith', 'Doe', 'Johnson', 'Brown', 'Lee', 'Davis', 'Miller', 'Wilson', 'Moore', 'Taylor'];
      
      const mockData = Array.from({ length: 20 }, (_, i) => {
          const age = 30 + Math.floor(Math.random() * 40);
          const hr = 120 + Math.floor(Math.random() * 60);
          const risk = 10 + Math.floor(Math.random() * 90);
          let category, riskClass;
          if (risk >= 70) { category = 'HIGH RISK'; riskClass = 'risk-high'; }
          else if (risk >= 40) { category = 'MODERATE RISK'; riskClass = 'risk-moderate'; }
          else { category = 'LOW RISK'; riskClass = 'risk-low'; }
          return { 
              id: `PID-${700 + i}`, 
              name: `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)][0]}.`,
              age, 
              hr, 
              risk, 
              category, 
              class: riskClass 
          };
      });
      
      // Add current user to the top
      const allPatients = [currentUserDecision, ...mockData];
      
      tableBody.innerHTML = ''; // Clear old data
      allPatients.forEach((patient, index) => {
          const row = document.createElement('tr');
          if (index === 0) {
              row.className = 'current-patient-row'; // Highlight current user
          }
          row.innerHTML = `
              <td style="padding: 12px; border-bottom: 1px solid #eee;">${patient.id}</td>
              <td style="padding: 12px; border-bottom: 1px solid #eee;">${patient.name}</td>
              <td style="padding: 12px; border-bottom: 1px solid #eee;">${patient.thalach || patient.hr}</td>
              <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: 700;" class="${patient.riskClass || patient.class}">${patient.riskScore || patient.risk}%</td>
              <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: 700;" class="${patient.riskClass || patient.class}">${patient.riskCategory || patient.category}</td>
          `;
          tableBody.appendChild(row);
      });
  }

  // NEW: Historical Risk Chart
  function updateHistoricalRiskChart() {
      const histCanvas = document.getElementById('historicalRiskChart');
      if (!histCanvas || typeof Chart === 'undefined') return;
      
      // *** REWRITE FIX ***: Destroy previous chart
      let existingChart = Chart.getChart(histCanvas);
      if (existingChart) {
          existingChart.destroy();
      }

      // Get the last 10 assessments, reversed
      const history = [...assessments].reverse().slice(-10);
      const labels = history.map(item => item.id);
      const data = history.map(item => item.riskScore);
      
      const config = {
          type: 'line',
          data: {
              labels: labels,
              datasets: [{
                  label: 'Risk Score History',
                  data: data,
                  borderColor: '#ff5823',
                  backgroundColor: 'rgba(255, 88, 35, 0.1)',
                  fill: true,
                  tension: 0.3
              }]
          },
          options: {
              animation: false, // Disable animation for stability
              scales: {
                  y: { beginAtZero: true, max: 100 },
                  x: { display: false }
              },
              plugins: { legend: { display: false } }
          }
      };
      
      const histRiskChartInstance = new Chart(histCanvas, config);
      
      // *** REWRITE FIX ***: Add resize delay
      setTimeout(() => {
          if (Chart.getChart(histCanvas)) {
              Chart.getChart(histCanvas).resize();
          }
      }, 100);
  }


  // --- Personalized Care & Predictions ---
  const populateList = (elementId, items) => {
      // MODIFIED: Check for element first
      const ul = document.querySelector(`${elementId}`);
      if (ul && Array.isArray(items)) {
          ul.innerHTML = items.map(item => `<li>${item}</li>`).join('');
      } else if (ul) {
          ul.innerHTML = `<li>${items || "N/A"}</li>`;
      }
  };

  function updatePersonalizedCare(decision) {
      const { carePlan } = decision;
      if (carePlan) {
        populateList('#ai-diet ul', carePlan.diet);
        populateList('#ai-exercise ul', carePlan.exercise);
        populateList('#ai-mind ul', carePlan.mind);
      }
  }

  // MODIFIED: This function now updates the "Clinical Decision Layer" page
  function updateAIPredictions(decision) {
      const { anomalyDetection, riskStratification, adaptiveTreatment } = decision;
      
      populateList('#ai-anomaly-list', anomalyDetection);
      populateList('#ai-stratification-list', riskStratification);
      populateList('#ai-treatment-list', adaptiveTreatment);
  }

  // --- Clinical Report Functions ---
  // MODIFIED: Updated to include new AI fields and framework concepts
  function updateClinicalReport(decision) {
      const report = generateReportText(decision);
      document.getElementById('report-content').textContent = report;
      
      // NEW: Generate QR Code
      const qrCanvas = document.getElementById('report-qr-code');
      if (qrCanvas) {
          document.getElementById('qr-code-container').style.display = 'block';
          new QRious({
              element: qrCanvas,
              value: report,
              size: 200,
              padding: 10,
              background: 'white',
              foreground: '#1d133a'
          });
      }
  }

  // MODIFIED: Report text now reflects the full framework
  function generateReportText(decision) {
      const aiData = decision || {};
      const carePlan = decision.carePlan || { diet: [], exercise: [], mind: [] };
      const vitals = decision.vitals || { bpm: '--', pr: '--', rr: '--', tm: '--' };

      return `
CARDIOFUSION PRO - CLINICAL REPORT
==================================

PATIENT DETAILS
----------------
Patient ID: ${decision.id}
Patient Name: ${decision.name}
Gender: ${decision.gender}
Age: ${decision.age}
Assessment Date: ${decision.timestamp}

DATA MANAGEMENT LAYER (SIMULATED)
---------------------------------
Sensor Sources: Wearable ECG, Smartwatch, EHR (Simulated)
Data Fusion: Multimodal data (Wearable, EHR, Imaging) fused for analysis.
Data Storage: Patient data secured (HIPAA-compliant simulation).

VITAL SIGNS & INPUTS (Patient & Sensors Layer)
----------------------------------------------
Chest Pain Type: ${decision.cpText}
Max Heart Rate (Thalach): ${decision.thalach}
ST Depression (Oldpeak): ${decision.oldpeak}
Thallium Test: ${decision.thalText}

ECG & LIVE VITALS (SIMULATED)
-----------------------------
Resting BPM: ${vitals.bpm}
PR Interval: ${vitals.pr} ms
RR Interval: ${vitals.rr} ms
TM Interval: ${vitals.tm} s
ECG Finding: Real-time analysis indicates ${decision.riskScore > 40 ? 'abnormalities consistent with risk level' : 'normal sinus rhythm'}.

CLINICAL DECISION LAYER (AI SIMULATION)
---------------------------------------
Risk Score: ${decision.riskScore}%
Risk Category: ${decision.riskCategory}
AI Findings: ${getAIFinding(decision.riskClass)}

[ ANOMALY DETECTION (Simulated GRU/Autoencoder) ]
${Array.isArray(aiData.anomalyDetection) ? aiData.anomalyDetection.map(item => `- ${item}`).join('\n') : 'N/A'}

[ RISK STRATIFICATION (Simulated) ]
${Array.isArray(aiData.riskStratification) ? aiData.riskStratification.map(item => `- ${item}`).join('\n') : 'N/A'}

[ ADAPTIVE TREATMENT (Simulated) ]
${Array.isArray(aiData.adaptiveTreatment) ? aiData.adaptiveTreatment.map(item => `- ${item}`).join('\n') : 'N/A'}


PERSONALIZED CARE PLAN (Feedback Layer)
-----------------------------------------
The following recommendations have been generated by the AI 
based on the patient's current risk profile.

[ DIET (FOODS) RECOMMENDATIONS ]
${Array.isArray(carePlan.diet) ? carePlan.diet.map(item => `- ${item}`).join('\n') : 'N/A'}

[ EXERCISE & ACTIVITY ]
${Array.isArray(carePlan.exercise) ? carePlan.exercise.map(item => `- ${item}`).join('\n') : 'N/A'}

[ STRESS & MIND ]
${Array.isArray(carePlan.mind) ? carePlan.mind.map(item => `- ${item}`).join('\n') : 'N/A'}

----------------------------------
END OF REPORT
Integration: Simulated data shared with [HOSPITAL-SYSTEM-XYZ]
Data Sharing: Real-time data available to [CARE-TEAM-PORTAL]
Disclaimer: This is a simulated report for demonstration purposes.
`;
  }
  
  function getAIFinding(riskClass) {
      if (riskClass === 'risk-high') return "High risk factors detected. Clinical follow-up is strongly recommended.";
      if (riskClass === 'risk-moderate') return "Elevated risk. Proactive lifestyle changes and regular monitoring are recommended.";
      return "Patient is in a low-risk category. Continue healthy habits and regular check-ups.";
  }

  // --- Download Report Function ---
  downloadReportBtn.addEventListener('click', () => {
      const reportText = generateReportText(currentDecision);
      const blob = new Blob([reportText], { type: 'text/plain' });
      const anchor = document.createElement('a');
      anchor.download = `CardioFusion_Report_${currentDecision.name.replace(' ','_')}_${currentDecision.timestamp.split(' ')[0]}.txt`;
      anchor.href = window.URL.createObjectURL(blob);
      anchor.click();
      window.URL.revokeObjectURL(anchor.href);
  });
  
  // --- NEW: Alarm & SMS Functions ---
  function triggerAlarm(decision) {
      alarmModal.classList.add('open');
      alarmSound.play();
  }
  
  alarmDismissBtn.addEventListener('click', () => {
      alarmModal.classList.remove('open');
      alarmSound.pause();
      alarmSound.currentTime = 0;
  });
  
  function openSmsModal() {
      // MODIFIED: Use the new "adaptiveTreatment" for the SOP
      const sop = currentDecision.adaptiveTreatment ? currentDecision.adaptiveTreatment.join(' ') : "Please follow emergency protocol.";
      const message = `EMERGENCY [SOP]: Patient ${currentDecision.name} (ID: ${currentDecision.id}) has a HIGH RISK score (${currentDecision.riskScore}%). Vitals: ${currentDecision.vitals.bpm} BPM. AI Recommendation: ${sop}`;
      smsMessageInput.value = message;
      smsPhoneInput.value = "+919529292990"; // Set phone number
      smsModal.classList.add('open');
      alarmModal.classList.remove('open'); // Hide alarm modal if open
  }
  
  alarmSmsBtn.addEventListener('click', openSmsModal);
  contactBtn1.addEventListener('click', openSmsModal);
  contactBtn2.addEventListener('click', openSmsModal);
  
  smsCancelBtn.addEventListener('click', () => {
      smsModal.classList.remove('open');
  });
  
  // NEW: Send to WhatsApp
  smsSendBtn.addEventListener('click', () => {
      const phone = smsPhoneInput.value;
      const message = smsMessageInput.value;
      
      // Create a WhatsApp-friendly URL
      const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      
      // Open WhatsApp in a new tab
      window.open(whatsappUrl, '_blank');
      
      alert(`SIMULATION:\nOpening WhatsApp to send emergency message to ${phone}.`);
      smsModal.classList.remove('open');
      alarmModal.classList.remove('open');
      alarmSound.pause();
      alarmSound.currentTime = 0;
  });
  
  // --- NEW: Telemedicine AI Chatbot ---
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input-text');
  const chatMessages = document.getElementById('chat-messages');
  
  chatForm.onsubmit = (e) => {
      e.preventDefault();
      const userMessage = chatInput.value.trim();
      if (userMessage === '') return;
      
      addChatMessage(userMessage, 'user');
      chatInput.value = '';
      getAIChatResponse(userMessage);
  };
  
  function addChatMessage(message, sender, isTyping = false) {
      const msgElement = document.createElement('div');
      msgElement.className = `chat-message ${sender}`;
      if (isTyping) {
          msgElement.id = 'typing-indicator';
          msgElement.innerHTML = '<i>Dr. Eva is typing...</i>';
      } else {
          // Render newlines
          msgElement.innerHTML = message.replace(/\n/g, '<br>');
      }
      chatMessages.appendChild(msgElement);
      chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
  }

  async function getAIChatResponse(userQuery) {
      addChatMessage('', 'bot', true); // Show typing indicator
      
      const systemPrompt = `You are Dr. Eva Reid, a helpful and empathetic AI cardiology assistant for CardioFusion Pro.
      A patient is asking you questions. Be concise, supportive, and informative.
      You MUST NOT provide medical advice. If you are asked for medical advice, you MUST state that you are an AI assistant and cannot provide medical advice, and that the patient should consult their human doctor or care team.
      If the patient mentions their assessment, you can use this data (if it exists):
      Patient Name: ${currentDecision?.name || 'N/A'}
      Risk Score: ${currentDecision?.riskScore || 'N/A'}
      Risk Category: ${currentDecision?.riskCategory || 'N/A'}
      
      Patient's question: "${userQuery}"`;
      
      const apiKey = ""; // API key is handled by the environment
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

      try {
          const payload = {
              contents: [{ parts: [{ text: userQuery }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] }
          };

          const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });

          if (!response.ok) {
              throw new Error(`API error: ${response.statusText}`);
          }

          const result = await response.json();
          const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
          
          document.getElementById('typing-indicator')?.remove();
          
          if (botResponse) {
              addChatMessage(botResponse, 'bot');
          } else {
              addChatMessage("I'm sorry, I couldn't process that. Please try again.", 'bot');
          }

      } catch (error) {
          console.error("AI Chat Error:", error);
          document.getElementById('typing-indicator')?.remove();
          addChatMessage("I'm having trouble connecting to my network right now. Please check your connection or try again later.", 'bot');
      }
  }
  
  // --- NEW: Video Call Simulation ---
  const videoPlaceholder = document.getElementById('video-placeholder');
  const localVideo = document.getElementById('local-video');
  const videoStatusText = document.getElementById('video-status-text');
  const videoControls = document.getElementById('video-controls');
  const startCallBtn = document.getElementById('start-call-btn');
  const endCallBtn = document.getElementById('end-call-btn');
  const videoIcon = videoPlaceholder.querySelector('i');
  const remoteVideoPlaceholder = document.getElementById('remote-video-placeholder');


  async function startVideoCall() {
      try {
          localMediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = localMediaStream;
          localVideo.style.display = 'block';
          videoIcon.style.display = 'none';
          videoStatusText.style.display = 'none';
          startCallBtn.style.display = 'none';
          endCallBtn.style.display = 'inline-flex';
          
          // Simulate doctor connecting
          remoteVideoPlaceholder.classList.add('connected');
          
      } catch (err) {
          console.error('Error accessing webcam:', err);
          videoStatusText.textContent = 'Error: Could not access webcam.';
      }
  }

  function stopVideoCall() {
      if (localMediaStream) {
          localMediaStream.getTracks().forEach(track => track.stop());
      }
      localVideo.srcObject = null;
      localVideo.style.display = 'none';
      videoIcon.style.display = 'block';
      videoStatusText.style.display = 'block';
      videoStatusText.textContent = 'Your video call has ended.';
      startCallBtn.style.display = 'inline-flex';
      endCallBtn.style.display = 'none';
      remoteVideoPlaceholder.classList.remove('connected');
  }
  
  // Show controls on Telemedicine page load
  document.querySelector('[data-page="page-telemedicine"]').addEventListener('click', () => {
    videoControls.style.display = 'flex';
  });
  startCallBtn.addEventListener('click', startVideoCall);
  endCallBtn.addEventListener('click', stopVideoCall);
  
  
  // --- NEW: Camera Heart Rate Simulation ---
  cameraBtn.addEventListener('click', async () => {
      if (cameraStream) {
          // If stream is active, stop it
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
          cameraFeed.style.display = 'none';
          cameraStatus.textContent = '';
          cameraBtn.innerHTML = '<i class="fa-solid fa-camera"></i> Scan Face for Heart Rate (Beta)';
          cameraBtn.classList.remove('secondary');
          cameraBtn.classList.add('primary');
          return;
      }
      
      try {
          cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
          cameraFeed.srcObject = cameraStream;
          cameraFeed.style.display = 'block';
          cameraFeed.play();
          cameraBtn.innerHTML = '<i class="fa-solid fa-stop"></i> Stop Camera';
          cameraBtn.classList.add('secondary'); // Make it a "stop" button
          cameraBtn.classList.remove('primary');
          cameraStatus.textContent = 'Scanning... Please hold still.';
          
          // Simulate a 5-second scan
          setTimeout(() => {
              if (!cameraStream) return; // Check if user already stopped it
              
              // Simulate a detected resting heart rate
              const detectedHR = Math.floor(Math.random() * (90 - 60 + 1)) + 60; // Random HR between 60-90
              
              thalachInput.value = detectedHR;
              thalachValue.textContent = detectedHR;
              
              // Stop the camera
              cameraStream.getTracks().forEach(track => track.stop());
              cameraStream = null;
              cameraFeed.style.display = 'none';
              cameraStatus.textContent = `Heart Rate Detected: ${detectedHR} BPM`;
              cameraBtn.innerHTML = '<i class="fa-solid fa-camera"></i> Scan Face for Heart Rate (Beta)';
              cameraBtn.classList.remove('secondary');
              cameraBtn.classList.add('primary');
              
          }, 5000); // 5-second simulation

      } catch (err) {
          console.error('Error accessing camera:', err);
          cameraStatus.textContent = 'Error: Could not access camera.';
      }
  });
  
  // ----------------------------------------------------
  // --- NEW: 3D Heart Simulation Logic (Three.js) ---
  // ----------------------------------------------------
  let heartSimulationRunning = false;
  let heartAnimationId = null;
  let threeScene, threeCamera, threeRenderer, heartModel, clock;
  const start3dBtn = document.querySelector('#heart-3d-container .submit-btn');
  const stop3dBtn = document.getElementById('stop-3d-btn');
  const heart3dInfo = document.getElementById('heart-3d-info');
  const simulationStatus = document.getElementById('simulation-status');

  function initializeThreeJS() {
    if (typeof THREE === 'undefined') {
      console.error("Three.js not loaded.");
      return;
    }
    
    const container = document.getElementById('heart-3d-container');
    const canvas = document.getElementById('heart-3d-canvas');
    if (!container || !canvas) return;

    const width = container.clientWidth;
    const height = container.clientHeight;

    // 1. Scene
    threeScene = new THREE.Scene();
    threeScene.background = new THREE.Color(0xf4f7f9); // Match page background

    // 2. Camera
    threeCamera = new THREE.PerspectiveCamera(50, width / height, 0.1, 1000);
    threeCamera.position.z = 5;

    // 3. Renderer
    threeRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
    threeRenderer.setSize(width, height);
    threeRenderer.setPixelRatio(window.devicePixelRatio);

    // 4. Lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    threeScene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(0, 1, 1).normalize();
    threeScene.add(directionalLight);

    // 5. Heart Model (Simplified Geometry)
    const shape = new THREE.Shape();
    // Simplified Heart shape path
    shape.moveTo(0.5, 1.5);
    shape.bezierCurveTo(0.5, 2.5, 0.0, 3.0, 0.0, 3.0);
    shape.bezierCurveTo(0.0, 3.0, -0.5, 2.5, -0.5, 1.5);
    shape.bezierCurveTo(-0.5, 0.5, 0.5, 0.5, 0.5, 1.5);
    shape.splineThru([
      new THREE.Vector2(0, 0.3),
      new THREE.Vector2(-1.0, 1.5),
      new THREE.Vector2(0, 2.5),
      new THREE.Vector2(1.0, 1.5),
      new THREE.Vector2(0, 0.3),
    ]);
    
    shape.lineTo(0, 0); // Pointy bottom
    shape.lineTo(0.5, 1.5);

    // Use LatheGeometry (revolution around Y axis) for a 3D-like shape
    const points = [];
    const numPoints = 12;
    for (let i = 0; i <= numPoints; i++) {
        const radius = 1.0 + 0.5 * Math.sin(i / numPoints * Math.PI);
        const y = i / numPoints * 2.0 - 1.0;
        points.push(new THREE.Vector2(radius * Math.abs(y), y * 1.5));
    }
    
    const geometry = new THREE.LatheGeometry(points, 20);
    
    // Simple red material (Risk-High color)
    const material = new THREE.MeshPhongMaterial({ 
        color: 0xD32F2F, 
        specular: 0x555555, 
        shininess: 30,
        flatShading: false
    }); 
    
    heartModel = new THREE.Mesh(geometry, material);
    heartModel.rotation.set(Math.PI / 2, 0, 0); // Tilt it slightly
    threeScene.add(heartModel);
    
    // Update camera/renderer on resize
    window.addEventListener('resize', onResize, false);
  }
  
  function onResize() {
    const container = document.getElementById('heart-3d-container');
    if (!threeRenderer || !threeCamera || !container) return;

    const width = container.clientWidth;
    const height = container.clientHeight;

    threeCamera.aspect = width / height;
    threeCamera.updateProjectionMatrix();
    threeRenderer.setSize(width, height);
  }

  function animateHeart() {
    if (!heartSimulationRunning) return;
    heartAnimationId = requestAnimationFrame(animateHeart);
    
    const time = clock.getElapsedTime();
    const bpm = currentDecision && currentDecision.vitals ? currentDecision.vitals.bpm : 72;
    const beatDuration = 60 / bpm; // Duration of one beat in seconds

    // Simple cardiac cycle simulation (scale model to simulate pulse)
    const cycleTime = time % beatDuration;
    let scaleFactor = 1.0;

    if (cycleTime < beatDuration * 0.2) {
      // Systole (contraction - maximum scale)
      scaleFactor = 1.0 + 0.1 * Math.sin(cycleTime / (beatDuration * 0.2) * Math.PI);
    } else {
      // Diastole (relaxation - return to baseline)
      scaleFactor = 1.0 + 0.1 * Math.exp(-(cycleTime - beatDuration * 0.2) / (beatDuration * 0.8));
    }

    // Apply scale and rotation
    heartModel.scale.set(scaleFactor, scaleFactor, scaleFactor);
    heartModel.rotation.y += 0.005;

    threeRenderer.render(threeScene, threeCamera);
  }
  
  function startHeartSimulation() {
    if (heartSimulationRunning) return;
    
    start3dBtn.style.display = 'none';
    stop3dBtn.style.display = 'inline-flex';
    heart3dInfo.style.display = 'none';
    simulationStatus.style.display = 'block';

    if (!threeScene) {
        initializeThreeJS();
    }
    
    clock = new THREE.Clock();
    heartSimulationRunning = true;
    animateHeart();
    
    // Save current parameters to the global decision object
    saveSimulationParameters();
    
    const bpm = currentDecision && currentDecision.vitals ? currentDecision.vitals.bpm : 72;
    simulationStatus.textContent = `SIMULATION RUNNING: BPM ${bpm} | Output: ${currentDecision.simulatedOutput || 'N/A'}`;
  }
  
  function stopHeartSimulation() {
    if (!heartSimulationRunning) return;
    
    heartSimulationRunning = false;
    cancelAnimationFrame(heartAnimationId);
    
    start3dBtn.style.display = 'inline-flex';
    stop3dBtn.style.display = 'none';
    heart3dInfo.style.display = 'block';
    simulationStatus.style.display = 'none';
  }

  function saveSimulationParameters() {
    if (!currentDecision) {
      currentDecision = {}; // Initialize if not present
    }

    const output = document.getElementById('cardiac-output').textContent;
    const ejf = document.getElementById('ejection-fraction').textContent;
    const apd = document.getElementById('ap-duration').textContent;
    const ws = document.getElementById('wall-stress').textContent;
    
    // Save simulation results to the main decision object
    currentDecision.simulatedOutput = output;
    currentDecision.simulatedEjectionFraction = ejf;
    currentDecision.simulatedAPDuration = apd;
    currentDecision.simulatedWallStress = ws;
    
    // Optional: Update the last assessment in storage with new data
    const lastAssessmentIndex = assessments.findIndex(a => a.id === currentDecision.id);
    if (lastAssessmentIndex !== -1) {
        assessments[lastAssessmentIndex] = currentDecision;
        localStorage.setItem('cardioAssessments', JSON.stringify(assessments));
    }
    
    console.log("3D Simulation parameters saved:", {
        output: output, ejf: ejf, apd: apd, ws: ws
    });
  }
  
  // ----------------------------------------------------
  // --- Chart & Data Functions (Standard Logic) ---
  // ----------------------------------------------------
  
  // Helper function to resize multiple charts
  function resizeCharts(ids) {
    setTimeout(() => {
      ids.forEach(id => {
        const chart = Chart.getChart(id);
        if (chart) {
          chart.resize();
        }
      });
    }, 150); // Small delay to ensure the DOM has rendered the new page layout
  }

  function initializeHeartModels() {
    // Use fixed electrophysiology data based on patient vitals or default values
    let bpm = 72; // Default
    if (currentDecision && currentDecision.vitals) {
      bpm = currentDecision.vitals.bpm;
    }
    
    // Calculate fixed values based on BPM (only once)
    const apDuration = Math.round(1000 / bpm * 60);
    const conductionVel = (0.6).toFixed(2);
    const cardiacOutput = (5.2 + (Math.random() * 0.5 - 0.25)).toFixed(2);
    const ejectionFraction = (62 + (Math.random() * 4 - 2)).toFixed(0);
    const contractility = (1.35 + (Math.random() * 0.1 - 0.05)).toFixed(2);
    const wallStress = (95 + (Math.random() * 10 - 5)).toFixed(0);
    
    const apEl = document.getElementById('ap-duration');
    const cvEl = document.getElementById('conduction-vel');
    const coEl = document.getElementById('cardiac-output');
    const efEl = document.getElementById('ejection-fraction');
    const ctEl = document.getElementById('contractility');
    const wsEl = document.getElementById('wall-stress');
    
    if (apEl) apEl.textContent = apDuration + ' ms';
    if (cvEl) cvEl.textContent = conductionVel + ' m/s';
    if (coEl) coEl.textContent = cardiacOutput + ' L/min';
    if (efEl) efEl.textContent = ejectionFraction + '%';
    if (ctEl) ctEl.textContent = contractility;
    if (wsEl) wsEl.textContent = wallStress + ' kPa';
    
    // Initialize charts if Chart.js is available
    if (typeof Chart !== 'undefined') {
      initializeHeartModelCharts(bpm);
      
      // *** FIX ***: Call resize helper after charts are (re)created
      resizeCharts([
        'electrophysiology-chart',
        'hemodynamics-chart',
        'mechanics-chart'
      ]);
    }
  }

  function initializeDataFusion() {
    // Fixed data fusion chart data
    const fixedECGData = [45, 52, 48, 55, 50, 58, 52, 60, 55, 62, 58, 65, 60, 63, 58, 55, 52, 50, 48, 45];
    const fixedImagingData = [30, 35, 32, 38, 35, 40, 38, 42, 40, 45, 42, 48, 45, 50, 48, 45, 42, 40, 38, 35];
    const fixedEHRData = [25, 28, 26, 30, 28, 32, 30, 35, 32, 38, 35, 40, 38, 42, 40, 38, 35, 32, 30, 28];
    
    // Initialize fusion chart
    if (typeof Chart !== 'undefined') {
      const fusionCanvas = document.getElementById('fusion-chart');
      // *** REWRITE FIX ***: Use modern check
      if (fusionCanvas && !Chart.getChart(fusionCanvas)) {
        const chartInstance = new Chart(fusionCanvas, {
          type: 'line',
          data: {
            labels: Array(20).fill('').map((_, i) => i),
            datasets: [
              { label: 'ECG Signal', data: fixedECGData, borderColor: '#667eea', tension: 0.4 },
              { label: 'Imaging Data', data: fixedImagingData, borderColor: '#764ba2', tension: 0.4 },
              { label: 'EHR Data', data: fixedEHRData, borderColor: '#f093fb', tension: 0.4 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // Disable animation for stability
            scales: { y: { beginAtZero: true } }
          }
        });
        // *** REWRITE FIX ***: Add resize delay
        setTimeout(() => { if (Chart.getChart(fusionCanvas)) Chart.getChart(fusionCanvas).resize(); }, 100);
      }
    }
  }
  
  function initializeAdaptiveModels() {
    // Update learning rate slider
    const learningRateInput = document.getElementById('learning-rate');
    const learningRateValue = document.getElementById('learning-rate-value');
    const feedbackWeightInput = document.getElementById('feedback-weight');
    const feedbackWeightValue = document.getElementById('feedback-weight-value');
    
    if (learningRateInput && learningRateValue) {
      learningRateInput.oninput = () => learningRateValue.textContent = learningRateInput.value;
    }
    if (feedbackWeightInput && feedbackWeightValue) {
      feedbackWeightInput.oninput = () => feedbackWeightValue.textContent = feedbackWeightInput.value;
    }
    
    // Initialize model evolution chart
    if (typeof Chart !== 'undefined') {
      const evolutionCanvas = document.getElementById('model-evolution-chart');
      // *** REWRITE FIX ***: Use modern check
      if (evolutionCanvas && !Chart.getChart(evolutionCanvas)) {
        const chartInstance = new Chart(evolutionCanvas, {
          type: 'line',
          data: {
            labels: ['v2.0', 'v2.1', 'v2.2', 'v2.3', 'v2.4', 'v2.4.1'],
            datasets: [{
              label: 'Model Accuracy',
              data: [91.2, 92.5, 93.1, 93.8, 94.0, 94.2],
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // Disable animation for stability
            scales: { y: { beginAtZero: false, min: 90, max: 100 } }
          }
        });
        // *** REWRITE FIX ***: Add resize delay
        setTimeout(() => { if (Chart.getChart(evolutionCanvas)) Chart.getChart(evolutionCanvas).resize(); }, 100);
      }
    }
  }
  
  function initializeMLOptimization() {
    // Update recommendations if patient data exists
    if (currentDecision) {
      const medRecs = document.getElementById('medication-recommendations');
      const lifestyleRecs = document.getElementById('lifestyle-recommendations');
      
      if (medRecs) {
        medRecs.innerHTML = '<li>Optimize beta-blocker dosage based on current heart rate</li><li>Consider ACE inhibitor for blood pressure management</li><li>Monitor medication interactions</li>';
      }
      if (lifestyleRecs) {
        lifestyleRecs.innerHTML = '<li>Maintain regular exercise routine (30 min/day)</li><li>Follow Mediterranean diet plan</li><li>Ensure 7-8 hours of quality sleep</li>';
      }
    }
    
    // Initialize charts
    if (typeof Chart !== 'undefined') {
      const efficacyCanvas = document.getElementById('treatment-efficacy-chart');
      const performanceCanvas = document.getElementById('ml-performance-chart');
      
      // *** REWRITE FIX ***: Use modern check
      if (efficacyCanvas && !Chart.getChart(efficacyCanvas)) {
        const chartInstance = new Chart(efficacyCanvas, {
          type: 'bar',
          data: {
            labels: ['Treatment A', 'Treatment B', 'Treatment C', 'Treatment D'],
            datasets: [{
              label: 'Predicted Efficacy',
              data: [85, 92, 78, 95],
              backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // Disable animation for stability
            scales: { y: { beginAtZero: true, max: 100 } }
          }
        });
        // *** REWRITE FIX ***: Add resize delay
        setTimeout(() => { if (Chart.getChart(efficacyCanvas)) Chart.getChart(efficacyCanvas).resize(); }, 100);
      }
      
      // *** REWRITE FIX ***: Use modern check
      if (performanceCanvas && !Chart.getChart(performanceCanvas)) {
        const chartInstance = new Chart(performanceCanvas, {
          type: 'radar',
          data: {
            labels: ['Accuracy', 'Precision', 'Recall', 'F1-Score', 'AUC'],
            datasets: [{
              label: 'Ensemble Model',
              data: [95.1, 94.5, 93.8, 94.2, 96.0],
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.2)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // Disable animation for stability
            scales: { r: { beginAtZero: true, max: 100 } }
          }
        });
        // *** REWRITE FIX ***: Add resize delay
        setTimeout(() => { if (Chart.getChart(performanceCanvas)) Chart.getChart(performanceCanvas).resize(); }, 100);
      }
    }
  }
  
  function initializeDataManagement() {
    // Fixed system health data (24-hour pattern)
    const fixedCPUData = [32, 30, 28, 30, 35, 40, 45, 42, 38, 35, 33, 32, 35, 38, 40, 38, 35, 33, 32, 30, 28, 30, 32, 30];
    const fixedMemoryData = [42, 40, 38, 40, 45, 48, 50, 48, 45, 42, 40, 38, 42, 45, 48, 45, 42, 40, 38, 40, 42, 40, 38, 40];
    const fixedNetworkData = [22, 20, 18, 20, 25, 28, 30, 28, 25, 22, 20, 18, 22, 25, 28, 25, 22, 20, 18, 20, 22, 20, 18, 20];
    
    // Initialize system health chart
    if (typeof Chart !== 'undefined') {
      const healthCanvas = document.getElementById('system-health-chart');
      // *** REWRITE FIX ***: Use modern check
      if (healthCanvas && !Chart.getChart(healthCanvas)) {
        const chartInstance = new Chart(healthCanvas, {
          type: 'line',
          data: {
            labels: Array(24).fill('').map((_, i) => `${i}:00`),
            datasets: [
              { label: 'CPU Usage', data: fixedCPUData, borderColor: '#667eea', tension: 0.4 },
              { label: 'Memory Usage', data: fixedMemoryData, borderColor: '#764ba2', tension: 0.4 },
              { label: 'Network Latency', data: fixedNetworkData, borderColor: '#f093fb', tension: 0.4 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // Disable animation for stability
            scales: { y: { beginAtZero: true } }
          }
        });
        // *** REWRITE FIX ***: Add resize delay
        setTimeout(() => { if (Chart.getChart(healthCanvas)) Chart.getChart(healthCanvas).resize(); }, 100);
      }
    }
  }
  
  function initializeHeartModelCharts(bpm = 72) {
    // Pre-calculated smooth physiological waveforms (completely fixed, no calculations)
    // Electrophysiology: Smooth action potential pattern
    const epData = [50.0, 51.2, 52.8, 54.5, 56.2, 58.0, 59.8, 61.5, 63.2, 64.8, 66.2, 67.5, 68.5, 69.2, 69.5, 69.2, 68.5, 67.5, 66.2, 64.8, 63.2, 61.5, 59.8, 58.0, 56.2, 54.5, 52.8, 51.2, 50.0, 48.8, 47.5, 46.2, 45.0, 44.0, 43.2, 42.5, 42.0, 41.8, 42.0, 42.5, 43.2, 44.0, 45.0, 46.2, 47.5, 48.8, 50.0, 51.2, 52.8, 54.5];
    
    // Hemodynamics: Smooth blood flow pattern
    const hemoData = [55.0, 56.5, 58.0, 59.5, 61.0, 62.5, 64.0, 65.5, 67.0, 68.2, 69.0, 69.5, 69.8, 69.5, 69.0, 68.2, 67.0, 65.5, 64.0, 62.5, 61.0, 59.5, 58.0, 56.5, 55.0, 53.5, 52.0, 50.5, 49.0, 47.8, 47.0, 46.5, 46.2, 46.5, 47.0, 47.8, 49.0, 50.5, 52.0, 53.5, 55.0, 56.5, 58.0, 59.5, 61.0, 62.5, 64.0, 65.5, 67.0, 68.2];
    
    // Mechanics: Smooth contractility pattern
    const mechData = [60.0, 61.5, 63.0, 64.5, 66.0, 67.5, 69.0, 70.5, 72.0, 73.2, 74.0, 74.5, 74.8, 74.5, 74.0, 73.2, 72.0, 70.5, 69.0, 67.5, 66.0, 64.5, 63.0, 61.5, 60.0, 58.5, 57.0, 55.5, 54.0, 52.8, 52.0, 51.5, 51.2, 51.5, 52.0, 52.8, 54.0, 55.5, 57.0, 58.5, 60.0, 61.5, 63.0, 64.5, 66.0, 67.5, 69.0, 70.5, 72.0, 73.2];
    
    const chartConfigs = [
      { id: 'electrophysiology-chart', data: epData, color: '#667eea' },
      { id: 'hemodynamics-chart', data: hemoData, color: '#764ba2' },
      { id: 'mechanics-chart', data: mechData, color: '#4facfe' }
    ];
    
    chartConfigs.forEach(config => {
      const canvas = document.getElementById(config.id);
      // *** REWRITE FIX ***: Use modern check
      if (canvas && !Chart.getChart(canvas)) {
        if (typeof Chart !== 'undefined') {
          const chartInstance = new Chart(canvas, {
            type: 'line',
            data: {
              labels: Array(50).fill(''),
              datasets: [{
                data: config.data,
                borderColor: config.color,
                borderWidth: 2.5,
                pointRadius: 0,
                pointHoverRadius: 0,
                tension: 0.5, // Higher tension for smoother curves
                fill: false,
                cubicInterpolationMode: 'monotone' // Smooth interpolation
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false, // No animation
              interaction: {
                intersect: false,
                mode: 'index'
              },
              elements: {
                line: {
                  tension: 0.5, // Smooth curve
                  borderJoinStyle: 'round',
                  borderCapStyle: 'round'
                }
              },
              scales: { 
                x: { 
                  display: false,
                  grid: { display: false }
                },
                y: { 
                  display: false,
                  grid: { display: false },
                  min: 0,
                  max: 100
                }
              },
              plugins: { 
                legend: { display: false },
                tooltip: { enabled: false }
              }
            }
          });
          // NOTE: We rely on the `resizeCharts` call in initializeHeartModels for the final redraw
        }
      }
    });
  }

  // --- NEW: Function to Download/Save Chart Data ---
  // *** REWRITE FIX ***: This function is now corrected
  function downloadChartData(chartId, chartName) {
    const canvas = document.getElementById(chartId);
    if (!canvas) {
      alert('Chart not found!');
      return;
    }
    
    // *** REWRITE FIX ***: Use modern Chart.getChart(id)
    let chartInstance = null;
    if (typeof Chart !== 'undefined') {
      chartInstance = Chart.getChart(chartId);
    }
    
    // Save as image
    const imageUrl = canvas.toDataURL('image/png');
    const imageLink = document.createElement('a');
    imageLink.download = `${chartName}_${new Date().toISOString().split('T')[0]}.png`;
    imageLink.href = imageUrl;
    imageLink.click();
    
    // Save data as CSV/JSON if chart instance exists
    if (chartInstance && chartInstance.data) {
      const data = chartInstance.data;
      let csvContent = '';
      let jsonData = {};
      
      // Build CSV
      if (data.labels && data.labels.length > 0) {
        csvContent = 'Label,' + data.datasets.map((ds, idx) => ds.label || `Dataset ${idx + 1}`).join(',') + '\n';
        data.labels.forEach((label, i) => {
          const row = [label];
          data.datasets.forEach(ds => {
            row.push(ds.data[i] !== undefined ? ds.data[i] : '');
          });
          csvContent += row.join(',') + '\n';
        });
      } else {
        // For datasets without labels
        data.datasets.forEach((ds, idx) => {
          csvContent += (ds.label || `Dataset ${idx + 1}`) + '\n';
          ds.data.forEach((value, i) => {
            csvContent += `${i},${value}\n`;
          });
        });
      }
      
      // Build JSON
      jsonData = {
        chartName: chartName,
        timestamp: new Date().toISOString(),
        labels: data.labels || [],
        datasets: data.datasets.map(ds => ({
          label: ds.label || 'Dataset',
          data: ds.data
        }))
      };
      
      // Download CSV
      const csvBlob = new Blob([csvContent], { type: 'text/csv' });
      const csvLink = document.createElement('a');
      csvLink.download = `${chartName}_data_${new Date().toISOString().split('T')[0]}.csv`;
      csvLink.href = URL.createObjectURL(csvBlob);
      csvLink.click();
      URL.revokeObjectURL(csvLink.href);
      
      // Download JSON
      const jsonBlob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
      const jsonLink = document.createElement('a');
      jsonLink.download = `${chartName}_data_${new Date().toISOString().split('T')[0]}.json`;
      jsonLink.href = URL.createObjectURL(jsonBlob);
      jsonLink.click();
      URL.revokeObjectURL(jsonLink.href);
      
      // Save to localStorage for backup
      const storageKey = `chartData_${chartName}_${new Date().toISOString().split('T')[0]}`;
      localStorage.setItem(storageKey, JSON.stringify(jsonData));
      
      alert(`Data saved successfully!\n- Image: ${chartName}.png\n- CSV: ${chartName}_data.csv\n- JSON: ${chartName}_data.json\n\nData also saved to browser storage.`);
    } else {
      // Just save image if no chart instance
      alert(`Chart image saved as ${chartName}.png`);
    }
  }
  
  // --- Function to Export All Chart Data ---
  // *** REWRITE FIX ***: This function is now corrected
  function exportAllChartData() {
    const allCharts = [
      { id: 'ecgChart', name: 'ECG' },
      { id: 'historicalRiskChart', name: 'HistoricalRisk' },
      { id: 'electrophysiology-chart', name: 'Electrophysiology' },
      { id: 'hemodynamics-chart', name: 'Hemodynamics' },
      { id: 'mechanics-chart', name: 'Mechanics' },
      { id: 'fusion-chart', name: 'DataFusion' },
      { id: 'model-evolution-chart', name: 'ModelEvolution' },
      { id: 'treatment-efficacy-chart', name: 'TreatmentEfficacy' },
      { id: 'ml-performance-chart', name: 'MLPerformance' },
      { id: 'system-health-chart', name: 'SystemHealth' }
    ];
    
    const allData = {
      exportDate: new Date().toISOString(),
      charts: []
    };
    
    allCharts.forEach(chart => {
      const canvas = document.getElementById(chart.id);
      if (canvas) {
        // *** REWRITE FIX ***: Use modern Chart.getChart(id)
        let chartInstance = null;
        if (typeof Chart !== 'undefined') {
          chartInstance = Chart.getChart(chart.id);
        }
        
        if (chartInstance && chartInstance.data) {
          allData.charts.push({
            name: chart.name,
            labels: chartInstance.data.labels || [],
            datasets: chartInstance.data.datasets.map(ds => ({
              label: ds.label || 'Dataset',
              data: ds.data
            }))
          });
        }
      }
    });
    
    // Download combined JSON
    const jsonBlob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
    const jsonLink = document.createElement('a');
    jsonLink.download = `AllChartsData_${new Date().toISOString().split('T')[0]}.json`;
    jsonLink.href = URL.createObjectURL(jsonBlob);
    jsonLink.click();
    URL.revokeObjectURL(jsonLink.href);
    
    // Save to localStorage
    localStorage.setItem('allChartsData', JSON.stringify(allData));
    
    alert('All chart data exported successfully!');
  }
  
  // --- Function to Export All Data as PDF ---
  // *** REWRITE FIX ***: This function is now corrected
  async function exportAllDataAsPDF() {
    if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
      alert('PDF libraries not loaded. Please wait a moment and try again.');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    let yPosition = 20;
    
    // Add header
    pdf.setFontSize(18);
    pdf.setTextColor(0, 122, 124);
    pdf.text('CardioFusion Pro - Complete Data Report', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 10;
    
    pdf.setFontSize(10);
    pdf.setTextColor(0, 0, 0);
    pdf.text(`Generated: ${new Date().toLocaleString()}`, pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 15;
    
    // Add patient information if available
    if (currentDecision) {
      pdf.setFontSize(14);
      pdf.text('Patient Information', 20, yPosition);
      yPosition += 8;
      
      pdf.setFontSize(10);
      pdf.text(`Patient ID: ${currentDecision.id || 'N/A'}`, 20, yPosition);
      yPosition += 6;
      pdf.text(`Name: ${currentDecision.name || 'N/A'}`, 20, yPosition);
      yPosition += 6;
      pdf.text(`Age: ${currentDecision.age || 'N/A'}`, 20, yPosition);
      yPosition += 6;
      pdf.text(`Gender: ${currentDecision.gender || 'N/A'}`, 20, yPosition);
      yPosition += 6;
      pdf.text(`Risk Score: ${currentDecision.riskScore || 'N/A'}%`, 20, yPosition);
      yPosition += 6;
      pdf.text(`Risk Category: ${currentDecision.riskCategory || 'N/A'}`, 20, yPosition);
      yPosition += 10;
    }
    
    // Collect all chart images
    const chartIds = [
      'ecgChart',
      'historicalRiskChart',
      'riskDistributionChart',
      'electrophysiology-chart',
      'hemodynamics-chart',
      'mechanics-chart',
      'fusion-chart',
      'model-evolution-chart',
      'treatment-efficacy-chart',
      'ml-performance-chart',
      'system-health-chart'
    ];
    
    const chartNames = [
      'ECG Monitor',
      'Historical Risk Trend',
      'Risk Distribution',
      'Electrophysiology Model',
      'Hemodynamics Model',
      'Mechanics Model',
      'Data Fusion Pipeline',
      'Model Evolution',
      'Treatment Efficacy',
      'ML Performance',
      'System Health'
    ];
    
    // Add charts to PDF
    for (let i = 0; i < chartIds.length; i++) {
      const chartId = chartIds[i];
      const chartName = chartNames[i];
      
      // Check if we need a new page
      if (yPosition > pageHeight - 80) {
        pdf.addPage();
        yPosition = 20;
      }
        
      try {
        // *** REWRITE FIX ***: Use modern Chart.getChart(id)
        let chartImage;
        const chartInstance = Chart.getChart(chartId);

        if (chartInstance) {
          chartImage = chartInstance.toBase64Image();
        } else {
          // Try to get canvas directly if no chart instance (e.g., if it's not rendered yet)
          const canvas = document.getElementById(chartId);
          if (canvas) {
            chartImage = canvas.toDataURL('image/png');
          } else {
            throw new Error('Chart instance or canvas not found');
          }
        }
          
        if (chartImage) {
          // Add chart title
          pdf.setFontSize(12);
          pdf.text(chartName, 20, yPosition);
          yPosition += 8;
            
          // Calculate image dimensions to fit page
          const imgWidth = pageWidth - 40;
          // Use a default aspect ratio if instance is not available, otherwise use instance's
          const aspectRatio = (chartInstance) ? (chartInstance.height / chartInstance.width) : (9/16);
          const imgHeight = aspectRatio * imgWidth;
            
          // Add image
          pdf.addImage(chartImage, 'PNG', 20, yPosition, imgWidth, Math.min(imgHeight, pageHeight - yPosition - 20));
          yPosition += Math.min(imgHeight, pageHeight - yPosition - 20) + 10;
        }
      } catch (error) {
        console.error(`Error adding chart ${chartName}:`, error);
        pdf.setFontSize(10);
        pdf.text(`${chartName}: Chart not available or not rendered.`, 20, yPosition);
        yPosition += 6;
      }
    }
    
    // Add summary data
    if (yPosition > pageHeight - 60) {
      pdf.addPage();
      yPosition = 20;
    }
    
    pdf.setFontSize(14);
    pdf.text('Data Summary', 20, yPosition);
    yPosition += 8;
    
    pdf.setFontSize(10);
    if (assessments && assessments.length > 0) {
      pdf.text(`Total Assessments: ${assessments.length}`, 20, yPosition);
      yPosition += 6;
      const avgRisk = assessments.reduce((sum, item) => sum + item.riskScore, 0) / assessments.length;
      pdf.text(`Average Risk Score: ${avgRisk.toFixed(1)}%`, 20, yPosition);
      yPosition += 6;
    }
    
    // Save PDF
    const fileName = `CardioFusion_Report_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(fileName);
    
    alert('PDF report generated successfully!');
  }

  // --- Initialize Page on Load ---
  // NEW: Load from localStorage
  window.addEventListener('DOMContentLoaded', () => {
      const storedAssessments = localStorage.getItem('cardioAssessments');
      if (storedAssessments) {
          try {
            assessments = JSON.parse(storedAssessments);
            // Ensure it's an array
            if (!Array.isArray(assessments)) {
                assessments = [];
            }
          } catch (e) {
            console.error("Could not parse stored assessments:", e);
            assessments = [];
          }

          // Find the highest existing ID to prevent duplicates
          if (assessments.length > 0) {
            const maxId = Math.max(...assessments.map(a => parseInt(a.id?.split('-')[1] || 0)));
            currentId = Math.max(maxId, 999) + 1;
          } else {
            currentId = 1000;
          }
          updateStats();
      }
      showHomePage(); // Start on the landing page
  });

</script>
</body>
</html>